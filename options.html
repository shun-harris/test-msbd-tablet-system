<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Options Page</title>
</head>
<body>
  <div id="app"></div>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
  <script src="https://js.stripe.com/v3/"></script>

  <style>
    :root{
      --gold1:#f3dc8a; --gold2:#b8922a;
      --text:#f3f4f6; --muted:#c9cacc;
      --panel:#131417; --ink:#0f0f10;
      --darkBtn:#121316; --border:rgba(255,255,255,.10);
      --success:#1f3a24; --successEdge:#2a5a36;
      --warn:#2f1b12; --warnEdge:#5a3a2a;
    }
    html,body{height:100%}
    body{margin:0;background:#0f0f10;color:var(--text);font-family:Inter,system-ui,Arial}

    .stage{min-height:100vh;display:flex;align-items:center;justify-content:center;
      background:radial-gradient(1200px 600px at 30% 10%, #1e1f23 0%, #0f1012 55%, #0c0d0f 100%);
      padding:28px 12px 60px;}
    .stack{width:min(980px,92%);margin:0 auto}

    h1{margin:6px 0 8px;font-size:clamp(34px,6.8vw,58px);font-weight:900;text-align:center}
    .sub{color:var(--muted);text-align:center;margin:0 0 24px;font-size:clamp(14px,2.6vw,18px)}

    .card{background:linear-gradient(180deg,#141519,#101114);border:1px solid var(--border);
      border-radius:16px;padding:18px;margin-top:18px;}
    .card h3{margin:2px 0 10px;font-size:18px}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:720px){ .grid2{grid-template-columns:1fr} }

    .btn{display:flex;align-items:center;justify-content:center;gap:10px;height:74px;
      border-radius:14px;border:1px solid var(--border);font-weight:800;
      font-size:clamp(18px,3.6vw,22px);cursor:pointer;background:var(--darkBtn);color:var(--gold1);
      transition: background-color .25s ease, color .25s ease, border-color .25s ease, opacity .2s ease, transform .06s ease;}
    .btn:active{transform:scale(.99)}
    .btn-gold{background:linear-gradient(180deg,var(--gold1),var(--gold2));color:#1b1400;border-color:transparent;}
    .btn-warn{background:linear-gradient(180deg,var(--warn),#1f1510);color:#ffd7b0;border-color:var(--warnEdge);}
    .btn-success{
      background:linear-gradient(180deg,var(--success),#162619) !important;
      color:#b9f6ce !important;
      border-color:var(--successEdge) !important;
      cursor:not-allowed !important;
      opacity:.96;
    }

    .fieldCard{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:720px){ .fieldCard{grid-template-columns:1fr} }
    .kv{background:#0f1012;border:1px solid var(--border);border-radius:12px;padding:12px 14px}
    .kv .k{color:#a9abb0;font-size:12px;margin:0 0 6px}
    .kv .v{font-weight:700}

    .minor-row{display:flex;justify-content:center;margin-top:12px;}
    .link-btn{background:transparent;border:0;cursor:pointer;color:var(--muted);font-weight:700;
      font-size:clamp(14px,2.6vw,16px);padding:6px 10px;border-radius:10px;}
    .link-btn:hover{color:var(--gold1);background:rgba(255,255,255,.06)}

    .swap-wrap{position:relative;min-height:220px;}
    .pane{transition:opacity .22s ease,transform .22s ease;}
    .pane.hide{opacity:0;transform:translateY(8px);pointer-events:none;position:absolute;inset:0;}
    .pane.show{opacity:1;transform:none;position:relative;}

    .payTitle{text-align:center;margin:2px 0 12px;font-weight:800;opacity:.9;}
    .payTitle > div:first-child{text-align:center;margin-bottom:16px;}

    /* QR Overlay */
    #qrOverlay{
      display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);
      z-index:1000;align-items:center;justify-content:center;
    }
    #qrBox{
      background:#141519;border-radius:16px;padding:22px;text-align:center;
      max-width:92%;box-shadow:0 0 40px rgba(0,0,0,.5);
    }
    
    /* Stripe Card Overlay */
    #stripeOverlay{
      display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);
      z-index:1000;align-items:center;justify-content:center;
    }
    #stripeBox{
      background:#141519;border-radius:16px;padding:28px;text-align:left;
      max-width:500px;width:92%;box-shadow:0 0 40px rgba(0,0,0,.5);
    }
    #stripeBox h3{
      color:#f3f4f6;margin:0 0 20px;font-size:24px;font-weight:800;
    }
    #card-element{
      background:#0f1012;border:1px solid var(--border);border-radius:12px;
      padding:14px;margin-bottom:20px;
    }
    .stripe-buttons{
      display:flex;gap:12px;justify-content:flex-end;
    }
    .stripe-buttons .btn{
      height:48px;min-width:120px;
    }
    
    /* Payment Success Animation */
    .payment-success-overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(1200px 600px at 30% 10%, #1e1f23 0%, #0f1012 55%, #0c0d0f 100%);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
      pointer-events: none; /* Prevent any interaction during transition */
    }
    
    /* Prevent scrollbar during success animation */
    body.success-showing {
      overflow: hidden !important;
    }
    
    .payment-success-content {
      text-align: center;
      transform: scale(0.8);
      opacity: 0;
      transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    .payment-success-content.show {
      transform: scale(1);
      opacity: 1;
    }
    
    .success-checkmark {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, #10b981, #059669);
      margin: 0 auto 24px;
      position: relative;
      box-shadow: 0 0 40px rgba(16, 185, 129, 0.4);
    }
    
    .success-checkmark::after {
      content: '';
      position: absolute;
      width: 24px;
      height: 12px;
      border: 3px solid white;
      border-top: none;
      border-right: none;
      transform: rotate(-45deg);
      top: 50%;
      left: 50%;
      margin-top: -8px;
      margin-left: -12px;
      animation: checkmark 0.8s ease-in-out 0.3s both;
    }
    
    @keyframes checkmark {
      0% {
        width: 0;
        height: 0;
      }
      25% {
        width: 0;
        height: 12px;
      }
      100% {
        width: 24px;
        height: 12px;
      }
    }
    
    .success-title {
      font-size: 28px;
      font-weight: 800;
      color: #f3f4f6;
      margin-bottom: 12px;
      animation: fadeInUp 0.6s ease-out 0.5s both;
    }
    
    .success-subtitle {
      font-size: 16px;
      color: #9ca3af;
      margin-bottom: 32px;
      animation: fadeInUp 0.6s ease-out 0.7s both;
    }
    
    .success-amount {
      font-size: 24px;
      font-weight: 800;
      color: var(--gold1);
      margin-bottom: 24px;
      animation: fadeInUp 0.6s ease-out 0.9s both;
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .success-pulse {
      position: absolute;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: rgba(16, 185, 129, 0.3);
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% {
        transform: scale(1);
        opacity: 1;
      }
      100% {
        transform: scale(1.5);
        opacity: 0;
      }
    }
    #qrImg{width:320px;height:320px;display:block;margin:0 auto 16px;background:#fff;border-radius:12px;}
    /* center the overlay "I'm Done" button */
    #qrDone{ display:block; margin:14px auto 0; }

    /* Cash Modal */
    .modalOverlay{
      display:none; position:fixed; inset:0; z-index:1100;
      background:rgba(0,0,0,.85); align-items:center; justify-content:center;
    }
    .modalBox{
      background:#141519; border:1px solid rgba(255,255,255,.10);
      border-radius:16px; padding:22px; max-width:min(520px,92%); text-align:center;
      box-shadow:0 0 40px rgba(0,0,0,.5);
    }
    .modalBox h3{ margin:0 0 8px; font-size:20px; font-weight:900; }
    .modalBox p{ margin:0 0 14px; color:#cfd3da; }
    .modalBox .btn{ height:auto; padding:12px 28px; font-size:18px; border-radius:10px; margin:0 auto; display:inline-flex; }
  </style>

  <script>
    // ===== Auto Toggle Live/Dev =====
    const DEV =
      location.hostname === 'localhost' ||
      location.hostname === '127.0.0.1' ||
      location.hostname === '0.0.0.0' ||
      location.hostname === '::1' ||
      location.protocol === 'file:'; // double-clicking an .html file

    const TEST = location.hostname === 'test.tablet.msbdance.com';

    // ===== Settings =====
    const SETTINGS = {
      HOME_URL: DEV
        ? './index.html'
        : TEST
        ? 'https://test.tablet.msbdance.com/'
        : 'https://tablet.msbdance.com/',
      OPTIONS_URL: DEV
        ? './options.html'
        : TEST
        ? 'https://test.tablet.msbdance.com/options.html'
        : 'https://tablet.msbdance.com/options.html',
    };

    (function(){
      const MAKE_ROUTE_URL="https://hook.us1.make.com/7o1igxij7s24myaep5mtc5k6fvxunqh8";
      const GHL_WEBHOOK_URL="https://services.leadconnectorhq.com/hooks/3RfSeF58PmlwTx5aIQ0a/webhook-trigger/1b53b6bb-c54a-45d9-8f47-7816dd36cab0";
      const CLASS_NAME="Salsa Basics";
      const $=(s,r=document)=>r.querySelector(s);

      const qs=new URLSearchParams(location.search);
      const phone=(qs.get("phone")||"").replace(/\D/g,"").slice(-10);
      const name=(qs.get("name")||"").trim();
      const email=(qs.get("email")||"").trim();
      const back=qs.get("back")||"";
      const ctx={kind:null};

      const escapeHtml=s=>String(s).replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

      function sendGHLCheckin(phone){
        if (!phone) return;
        const u=`${GHL_WEBHOOK_URL}?phone=${encodeURIComponent(phone)}&evt=free_salsa_basics&src=tablet&ts=${Date.now()}`;
        new Image().src=u;
      }
      async function routeViaMakeDirect({phone,name,product}){
        try{
          const r=await fetch(MAKE_ROUTE_URL,{method:"POST",headers:{"Content-Type":"application/json"},
            body:JSON.stringify({phone,name,product,src:"tablet",ts:Date.now()})});
          if(!r.ok) return null;
          const d=await r.json().catch(()=>null);
          return d && d.url ? d.url : null;
        }catch(_){return null;}
      }

      function show(el){el.classList.remove("hide");el.classList.add("show");}
      function hide(el){el.classList.remove("show");el.classList.add("hide");}

      function showQr(url){
        const qrOverlay=$("#qrOverlay"),qrImg=$("#qrImg");
        qrImg.src=`https://api.qrserver.com/v1/create-qr-code/?size=320x320&data=${encodeURIComponent(url)}`;
        qrOverlay.style.display="flex";
        try{confetti({particleCount:80,spread:60,origin:{y:.6}});}catch(_){}
      }

      function showCashModal(){
        const el=$("#cashOverlay");
        el.style.display="flex";
        try{confetti({particleCount:40,spread:50,origin:{y:.6}});}catch(_){}
        $("#cashOk").onclick=()=>{location.href=SETTINGS.HOME_URL;};
      }

      function renderMain(){
        document.getElementById("app").innerHTML=`
          <div class="stage"><div class="stack">
            <h1>Welcome${name?`, ${escapeHtml(name)}`:""}!</h1>
            <p class="sub">You're all set — pick an option below.</p>
            <div class="card">
              <div class="swap-wrap">
                <div id="panePrimary" class="pane show">
                  <h3>Quick Actions</h3>
                  <div class="grid2">
                    <button id="btnCheck" class="btn">Check in: ${escapeHtml(CLASS_NAME)}</button>
                    <button id="btnSingle" class="btn">Buy a Single Class</button>
                  </div>
                  <div class="grid2" style="margin-top:14px">
                    <button id="btnMembership" class="btn btn-gold">Buy Unlimited (Membership)</button>
                    <button id="btnDone" class="btn" style="color:#e5e7eb">Done</button>
                  </div>
                </div>
                <div id="panePay" class="pane hide">
                  <div class="payTitle" id="payTitle"></div>
                  <div class="grid2" id="payOptions"></div>
                  <div class="grid2" style="margin-top:14px">
                    <button id="payBack" class="btn">← Back</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="card"><div class="fieldCard">
              <div class="kv"><div class="k">Guest</div><div class="v">${name||"—"}</div></div>
              <div class="kv"><div class="k">Phone</div><div class="v">${phone||"—"}</div></div>
              ${email ? `<div class="kv"><div class="k">Email</div><div class="v">${email}</div></div>` : ''}
            </div></div>
            <div class="minor-row"><button id="notMeGoBack" class="link-btn">Not me</button></div>
          </div></div>

          <!-- QR Overlay -->
          <div id="qrOverlay">
            <div id="qrBox">
              <img id="qrImg" alt="Scan to pay">
              <button id="qrDone" class="btn btn-gold">I’m Done</button>
            </div>
          </div>

          <!-- Cash Modal -->
          <div id="cashOverlay" class="modalOverlay">
            <div class="modalBox">
              <h3>Pay with cash</h3>
              <p>Please head to registration to finish your purchase.</p>
              <button id="cashOk" class="btn btn-gold">OK</button>
            </div>
          </div>

          <!-- Payment Success Overlay -->
          <div class="payment-success-overlay" id="paymentSuccessOverlay">
            <div class="payment-success-content" id="paymentSuccessContent">
              <div class="success-checkmark">
                <div class="success-pulse"></div>
              </div>
              <div class="success-title">Payment Successful</div>
              <div class="success-subtitle">Thank you for your purchase!</div>
              <div class="success-amount" id="successAmount"></div>
            </div>
          </div>
          
          <!-- Stripe Card Overlay -->
          <div id="stripeOverlay">
            <div id="stripeBox">
              <h3 id="stripe-modal-title">Enter Card Information</h3>
              
              <!-- Quantity Selector (only for single classes) -->
              <div id="quantity-section" style="background: #0f1012; border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 20px; display: none;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                  <span style="font-weight: 700; color: #f3f4f6;">Quantity:</span>
                  <div style="display: flex; align-items: center; gap: 12px;">
                    <button type="button" id="qty-minus" class="btn" style="height: 40px; min-width: 40px; padding: 0;">−</button>
                    <span id="quantity-display" style="font-size: 18px; font-weight: 800; min-width: 20px; text-align: center; color: #f3f4f6;">1</span>
                    <button type="button" id="qty-plus" class="btn" style="height: 40px; min-width: 40px; padding: 0;">+</button>
                  </div>
                </div>
                <div style="display: flex; align-items: center; justify-content: space-between;">
                  <span style="color: #9ca3af;">$20 per class</span>
                  <span style="font-size: 20px; font-weight: 800; color: var(--gold1);" id="total-display">$20</span>
                </div>
              </div>
              
              <form id="payment-form">
                <div id="card-element"></div>
                <p id="card-error" role="alert" style="color: #ff6b6b; display: none; margin: 10px 0;"></p>
                <div class="stripe-buttons">
                  <button type="button" id="stripe-cancel" class="btn">Cancel</button>
                  <button type="submit" id="stripe-submit" class="btn btn-gold">Confirm Purchase</button>
                </div>
              </form>
              
              <div id="saved-cards-section" style="margin-top: 24px; border-top: 1px solid var(--border); padding-top: 20px;">
                <h4 style="color: #f3f4f6; margin: 0 0 12px;">Or use a saved card:</h4>
                <div id="saved-cards" class="fieldCard">
                  <!-- Cards will be dynamically populated here -->
                </div>
              </div>
            </div>
          </div>
        `;

        // wire buttons
        const panePrimary=$("#panePrimary"),panePay=$("#panePay");
        const payTitle=$("#payTitle"),payOptions=$("#payOptions");
        if(back) $("#notMeGoBack").onclick=()=>{location.href=back}; else $("#notMeGoBack").style.display="none";

        // CHECK-IN button: fade green + lock
        $("#btnCheck").onclick=()=>{ 
          if(!phone) return; 
          const b=$("#btnCheck");
          b.disabled=true;
          b.textContent="Checking in…";
          b.classList.add("btn-success");
          sendGHLCheckin(phone);
          setTimeout(()=>{ 
            try{confetti({particleCount:120,spread:70,origin:{y:.6}});}catch(_){} 
            b.textContent="Checked in ✓";
          },180);
        };

        // Done → live home
        const doneButton = $("#btnDone");
        if (doneButton) {
          doneButton.onclick = () => {
            console.log("Button clicked"); // Log button click
            console.log("DEV mode:", DEV); // Log DEV mode status

            // Redirect logic
            location.href = SETTINGS.HOME_URL;
          };
        } else {
          console.error("Done button not found"); // Log error if button is missing
        }

        // Add quantity tracking
        let classQuantity = 1;
        
        function updateClassTotal() {
          const total = classQuantity * 20;
          const quantityDisplay = document.getElementById('quantity-display');
          const totalDisplay = document.getElementById('total-display');
          if (quantityDisplay) quantityDisplay.textContent = classQuantity;
          if (totalDisplay) totalDisplay.textContent = `$${total}`;
        }
        
        function openPayPane(kind){
          ctx.kind=kind;
          classQuantity = 1; // Reset quantity
          payTitle.textContent=(kind==="membership")?"Unlimited (Membership) — choose a payment method":"Single Class — choose a payment method";
          let buttons=`
            <button id="payCard" class="btn btn-gold">Enter card info</button>
            <button id="payQR" class="btn">Pay on phone (QR)</button>`;
          if(kind!=="membership"){buttons+=`<button id="payCash" class="btn btn-warn">Pay with cash</button>`;}
          payOptions.innerHTML=buttons;
          hide(panePrimary);show(panePay);

          $("#payBack").onclick=()=>{hide(panePay);show(panePrimary)};
          $("#payCard").onclick=()=>{
            showStripeCardForm();
          };
          $("#payQR").onclick=async()=>{
            const btn=$("#payQR");btn.textContent="Generating QR…";btn.disabled=true;
            const product=(ctx.kind==="membership")?"membershipqr":"singleqr";
            let url=await routeViaMakeDirect({phone,name,product});
            btn.textContent="Pay on phone (QR)";btn.disabled=false;
            if(url) showQr(url); else alert("QR unavailable.");
          };
          if($("#payCash")) $("#payCash").onclick=showCashModal;
        }
        $("#btnSingle").onclick=()=>openPayPane("single");
        $("#btnMembership").onclick=()=>openPayPane("membership");

        // Overlay close goes back to home (main input page)
        $("#qrDone").onclick=()=>{ location.href = SETTINGS.HOME_URL; };

        // Fix 'Not me' button logic
        if (back) {
          const notMeButton = $("#notMeGoBack");
          notMeButton.onclick = () => {
            let dest = SETTINGS.HOME_URL; // Default fallback
            try {
              const decodedBack = decodeURIComponent(back);
              if (/^https?:\/\//i.test(decodedBack)) {
                dest = decodedBack;
              }
            } catch (error) {
              console.error("Failed to decode 'back' parameter:", error);
            }
            location.href = dest;
          };
        } else {
          $("#notMeGoBack").style.display = "none";
        }

        // Stripe overlay functionality
        const stripeOverlay = document.getElementById('stripeOverlay');
        
        function showStripeCardForm() {
          // Update modal title and show/hide quantity based on product type
          const modalTitle = document.getElementById('stripe-modal-title');
          const quantitySection = document.getElementById('quantity-section');
          
          if (ctx.kind === 'membership') {
            modalTitle.textContent = 'Purchase Unlimited Membership';
            quantitySection.style.display = 'none';
          } else {
            modalTitle.textContent = 'Purchase Single Classes';
            quantitySection.style.display = 'block';
            classQuantity = 1; // Reset quantity
            updateClassTotal();
            
            // Add quantity button handlers
            document.getElementById('qty-minus').onclick = () => {
              if(classQuantity > 1) {
                classQuantity--;
                updateClassTotal();
              }
            };
            document.getElementById('qty-plus').onclick = () => {
              if(classQuantity < 10) { // Max 10 classes
                classQuantity++;
                updateClassTotal();
              }
            };
          }
          
          stripeOverlay.style.display = 'flex';
        }
        
        function hideStripeCardForm() {
          stripeOverlay.style.display = 'none';
        }
        
        // Cancel button functionality
        document.getElementById('stripe-cancel').onclick = hideStripeCardForm;



        // Stripe Elements - (old static init removed; using dynamic init below)
        // const stripe = Stripe('pk_test_...');
        // const elements = stripe.elements();
        // const cardElement = elements.create('card', { /* ... */ });
        // cardElement.mount('#card-element');

        const paymentForm = document.getElementById('payment-form');
        const cardError = document.getElementById('card-error');
        const submitButton = document.getElementById('stripe-submit');
        let currentProductType = '';
        let clientSecret = '';

        // Determine environment dynamically
        const HOST = location.hostname;
        const IS_LOCAL = HOST === 'localhost' || HOST === '127.0.0.1' || HOST === '0.0.0.0' || HOST === '::1';
        const IS_TEST = HOST === 'test.tablet.msbdance.com';
        const IS_PROD = HOST === 'tablet.msbdance.com';

        // Allow manual override of Stripe mode (only on test/local) to point at live stack for exploratory testing
        const RAW_SAVED_MODE = (!IS_PROD && localStorage.getItem('stripeMode')) || 'test';
        const FORCED_STRIPE_MODE = (RAW_SAVED_MODE === 'live' ? 'live' : 'test');
        const USING_LIVE = IS_PROD || FORCED_STRIPE_MODE === 'live';

        // Backend target toggle (remote vs local) - only relevant on non-prod
        const RAW_BACKEND_MODE = (!IS_PROD && localStorage.getItem('backendMode')) || 'remote';
        const BACKEND_MODE = (RAW_BACKEND_MODE === 'local' ? 'local' : 'remote');
        const LOCAL_BACKEND_URL = 'http://localhost:3000';
        const REMOTE_TEST_URL = 'https://test-msbd-tablet-system-production.up.railway.app';
        const REMOTE_PROD_URL = 'https://msbd-tablet-system-production.up.railway.app';

        // API base selection
        let API_BASE;
        if (BACKEND_MODE === 'local' && IS_LOCAL) {
          API_BASE = LOCAL_BACKEND_URL; // force local only if truly on a local host
        } else {
          API_BASE = USING_LIVE ? REMOTE_PROD_URL : REMOTE_TEST_URL;
        }

        // Publishable key selection
        const STRIPE_LIVE_KEY = (window.STRIPE_LIVE_PUBLISHABLE_KEY || 'pk_live_51LapNkD6NCrArHXBtnfJ2D86hnEKmWgz300JjIl2xklRzYnRlzpDtdXMLUoI24V4RaVkV5IW317IoQqvhUEmqhlR004hLXlB6Q');
        const STRIPE_TEST_KEY = 'pk_test_51LapNkD6NCrArHXBoKFz9KVTLcNnx6pAcql7bs3YxK3qCXxVhtdBOzCupwMv1J5Io3oPwjqFUGPTJrxnWumumJww00eyBAuzLh';
        const STRIPE_PUBLISHABLE_KEY = USING_LIVE ? STRIPE_LIVE_KEY : STRIPE_TEST_KEY;
  // Debug instrumentation flag (?stripeDebug=1 or localStorage.setItem('stripeDebug','1'))
  const STRIPE_DEBUG = (qs.get('stripeDebug') === '1') || (localStorage.getItem('stripeDebug') === '1');
  if (STRIPE_DEBUG) console.warn('[StripeDebug] Enabled. Skipping Link suppression and enabling diagnostics overlay.');

        // ---- Backend Availability Probe ----
        (function probeBackend(){
          // Only show warnings for non-production hosts where user might be confused by network errors
            const bannerId = 'api-health-banner';
            function showBanner(html){
              if(document.getElementById(bannerId)) return;
              const div = document.createElement('div');
              div.id = bannerId;
              div.innerHTML = `
                <style>
                  #${bannerId}{position:fixed;top:0;left:0;right:0;z-index:1600;font-family:Inter,system-ui,Arial;font-size:13px;}
                  #${bannerId} .inner{background:#3f1d1d;color:#ffd4d4;padding:10px 14px;display:flex;gap:12px;align-items:center;flex-wrap:wrap;box-shadow:0 4px 18px -4px rgba(0,0,0,.5);}
                  #${bannerId} button{background:#ffd4d4;color:#3f1d1d;border:0;padding:6px 10px;border-radius:6px;font-weight:700;cursor:pointer;font-size:12px;}
                </style>
                <div class="inner">${html}</div>`;
              document.body.appendChild(div);
            }
            async function check(url){
              const ctl = new AbortController();
              const tid = setTimeout(()=>ctl.abort(), 4500);
              try{
                const r = await fetch(url+'/health',{signal:ctl.signal});
                clearTimeout(tid);
                if(!r.ok) return { ok:false, status:r.status };
                const txt = await r.text();
                return { ok: true, body: txt };
              }catch(e){ return { ok:false, error:String(e) }; }
            }
            // Only probe after DOM ready minimal delay so body exists
            setTimeout(async ()=>{
              if(IS_PROD) return; // Do not clutter production tablet UI
              const res = await check(API_BASE);
              if(!res.ok){
                if(USING_LIVE){
                  showBanner(`Live backend <code>${API_BASE}</code> is unreachable (network / CORS / 404). Live mode cannot work locally until it responds. <button id="revertTestBtn">Switch back to TEST</button>`);
                  const btn = document.getElementById('revertTestBtn');
                  if(btn) btn.onclick=()=>{ localStorage.setItem('stripeMode','test'); location.reload(); };
                }else{
                  showBanner(`Test backend <code>${API_BASE}</code> is unreachable. Card form will fail. Please check server deployment.`);
                }
              }
            }, 200);
        })();

        // Inject toggle UI (non-prod only)
        (function injectStripeToggle(){
          if(IS_PROD) return; // never show on production
          const bar = document.createElement('div');
          bar.id = 'stripe-mode-toggle';
          bar.innerHTML = `
            <style>
              #stripe-mode-toggle{position:fixed;top:8px;right:8px;z-index:1500;font-family:Inter,system-ui,Arial}
              #stripe-mode-toggle .sm-pill{display:flex;gap:6px;background:#141519;border:1px solid var(--border);padding:6px 10px;border-radius:999px;align-items:center;box-shadow:0 4px 18px -6px rgba(0,0,0,.6);flex-wrap:wrap;}
              #stripe-mode-toggle button{background:#0f1012;border:1px solid var(--border);color:#cbd1d8;font-size:11px;padding:4px 10px;border-radius:20px;cursor:pointer;font-weight:600;letter-spacing:.5px;}
              #stripe-mode-toggle button.active{background:linear-gradient(180deg,var(--gold1),var(--gold2));color:#1b1400;border-color:transparent;}
              #stripe-mode-toggle .warn{color:#f59e0b;font-size:10px;font-weight:600;margin-left:4px;}
              #stripe-mode-toggle .dot{width:8px;height:8px;border-radius:50%;background:var(--gold1);box-shadow:0 0 0 3px rgba(0,0,0,.4)}
              #stripe-mode-toggle .group-label{font-size:10px;font-weight:700;opacity:.55;margin:0 2px 0 6px;}
            </style>
            <div class="sm-pill">
              <div class="dot" title="Stripe mode status"></div>
              <span style="font-size:11px;font-weight:700;opacity:.7;">Stripe</span>
              <button data-mode="test">TEST</button>
              <button data-mode="live">LIVE</button>
              <span class="warn" id="stripeModeWarn" style="display:none;">LIVE!</span>
              <span class="group-label">Backend</span>
              <button data-backend="remote">REMOTE</button>
              <button data-backend="local">LOCAL</button>
            </div>`;
          document.body.appendChild(bar);
          const modeBtns = bar.querySelectorAll('button[data-mode]');
          modeBtns.forEach(b=>{
            if(b.getAttribute('data-mode')===FORCED_STRIPE_MODE) b.classList.add('active');
            b.addEventListener('click',()=>{
              const mode = b.getAttribute('data-mode');
              if(mode==='live' && FORCED_STRIPE_MODE!=='live'){
                const ok = confirm('Switch to LIVE Stripe? REAL charges will be created. Continue?');
                if(!ok) return;
              }
              localStorage.setItem('stripeMode', mode);
              location.reload();
            });
          });
          const backendBtns = bar.querySelectorAll('button[data-backend]');
          backendBtns.forEach(b=>{
            if(b.getAttribute('data-backend')===BACKEND_MODE) b.classList.add('active');
            b.addEventListener('click',()=>{
              const tgt = b.getAttribute('data-backend');
              if(tgt==='local' && !IS_LOCAL){
                alert('Local backend only available when running on a localhost host.');
                return;
              }
              localStorage.setItem('backendMode', tgt);
              location.reload();
            });
          });
          if(FORCED_STRIPE_MODE==='live') bar.querySelector('#stripeModeWarn').style.display='inline';
        })();

        // Re-init Stripe with dynamic key
        const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
        console.log('[ENV] Host:', HOST, 'API_BASE:', API_BASE, 'Using key:', STRIPE_PUBLISHABLE_KEY.includes('live') ? 'LIVE' : 'TEST');

        // API base URL - update this to your server URL
        const DEV_MODE = false; // Set to false when server is running

        // Get product type and pricing
        function getProductInfo() {
          const productType = ctx.kind || 'single';
          let amount;
          if (productType === 'membership') {
            amount = 89.00;
          } else {
            amount = classQuantity * 20.00; // $20 per class
          }
          return { productType, amount, quantity: classQuantity };
        }

        // Load saved cards
        async function loadSavedCards() {
          try {
            let data;
            
            if (DEV_MODE) {
              // Mock data for development
              data = {
                payment_methods: [
                  { id: 'pm_mock_1', brand: 'visa', last4: '4242' },
                  { id: 'pm_mock_2', brand: 'mastercard', last4: '1234' }
                ]
              };
            } else {
              const response = await fetch(`${API_BASE}/get-payment-methods`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ phone, email })
              });
              
              data = await response.json();
            }
            const savedCardsContainer = document.getElementById('saved-cards');
            savedCardsContainer.innerHTML = '';
            
            if (data.payment_methods && data.payment_methods.length > 0) {
              data.payment_methods.forEach((card) => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'kv';
                cardDiv.style.cursor = 'pointer';
                cardDiv.innerHTML = `
                  <div class="k">Card ending in</div>
                  <div class="v">${card.brand.toUpperCase()} •••• ${card.last4}</div>
                `;
                cardDiv.onclick = () => useStoredCard(card);
                savedCardsContainer.appendChild(cardDiv);
              });
            } else {
              savedCardsContainer.innerHTML = '<p style="color: #9ca3af; text-align: center;">No saved cards</p>';
            }
          } catch (error) {
            console.error('Error loading saved cards:', error);
          }
        }

        // Use stored card for payment
        async function useStoredCard(card) {
          try {
            submitButton.textContent = 'Processing...';
            submitButton.disabled = true;
            
            const { productType, amount } = getProductInfo();
            
            const response = await fetch(`${API_BASE}/create-payment-intent`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                phone,
                name,
                email,
                amount,
                product_type: productType,
                payment_method_id: card.id
              })
            });
            
            const data = await response.json();
            
            if (data.error) {
              throw new Error(data.error);
            }
            
            handlePaymentResult(data);
          } catch (error) {
            cardError.textContent = error.message;
            cardError.style.display = 'block';
            submitButton.textContent = 'Confirm Purchase';
            submitButton.disabled = false;
          }
        }

        // Handle payment result
        function handlePaymentResult(data) {
          if (data.status === 'succeeded') {
            showPaymentSuccess();
          } else if (data.status === 'requires_action') {
            stripe.confirmCardPayment(data.client_secret).then(function(result) {
              if (result.error) {
                cardError.textContent = result.error.message;
                cardError.style.display = 'block';
              } else {
                handlePaymentResult({status: 'succeeded'});
              }
            });
          } else {
            throw new Error('Payment failed');
          }
        }
        
        // Show elegant payment success animation
        function showPaymentSuccess() {
          hideStripeCardForm();
          
          const { amount } = getProductInfo();
          const successOverlay = document.getElementById('paymentSuccessOverlay');
          const successContent = document.getElementById('paymentSuccessContent');
          const successAmount = document.getElementById('successAmount');
          
          // Prevent scrollbar during animation
          document.body.classList.add('success-showing');
          
          successAmount.textContent = `$${amount.toFixed(2)}`;
          successOverlay.style.display = 'flex';
          
          // Trigger animation
          setTimeout(() => {
            successContent.classList.add('show');
          }, 100);
          
          // Start slide-out animation and navigation after 2 seconds (reduced from 3)
          setTimeout(() => {
            // Start navigation immediately while slide-out begins
            location.href = SETTINGS.HOME_URL;
            
            // Start slide-out animation at the same time
            successContent.style.transform = 'translateY(-50px)';
            successContent.style.opacity = '0';
            successContent.style.transition = 'all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
          }, 2000);
        }

        // Form submission for new cards
        paymentForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          cardError.style.display = 'none';
          submitButton.textContent = 'Processing...';
          submitButton.disabled = true;
          
          try {
            if (DEV_MODE) {
              // Mock successful payment for development
              setTimeout(() => {
                showPaymentSuccess();
                submitButton.textContent = 'Confirm Purchase';
                submitButton.disabled = false;
              }, 2000);
              return;
            }
            // First create setup intent to save the card
            const setupResponse = await fetch(`${API_BASE}/create-setup-intent`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ phone, name, email })
            });
            
            const setupData = await setupResponse.json();
            if (setupData.error) throw new Error(setupData.error);
            
            // Confirm the setup intent to save the card
            const { setupIntent, error: setupError } = await stripe.confirmCardSetup(
              setupData.client_secret,
              {
                payment_method: {
                  card: cardElement,
                  billing_details: { name }
                }
              }
            );
            
            if (setupError) {
              throw new Error(setupError.message);
            }
            
            // Now create payment intent with the saved card
            const { productType, amount } = getProductInfo();
            
            const paymentResponse = await fetch(`${API_BASE}/create-payment-intent`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                phone,
                name,
                email,
                amount,
                product_type: productType,
                payment_method_id: setupIntent.payment_method
              })
            });
            
            const paymentData = await paymentResponse.json();
            if (paymentData.error) throw new Error(paymentData.error);
            
            handlePaymentResult(paymentData);
            
          } catch (error) {
            cardError.textContent = error.message;
            cardError.style.display = 'block';
            submitButton.textContent = 'Confirm Purchase';
            submitButton.disabled = false;
          }
        });

        // Update showStripeCardForm to load saved cards
        const originalShowStripeCardForm = showStripeCardForm;
        showStripeCardForm = function() {
          originalShowStripeCardForm();
          loadSavedCards();
        };

        // Stripe Elements initialization
        const elements = stripe.elements();
        const cardElement = elements.create('card', {
          // Removed disableLink (undocumented for standalone card) to avoid live-mode structure side effects
          style: {
            base: {
              color: '#f3f4f6',
              fontFamily: 'Inter, system-ui, Arial',
              fontSize: '16px',
              '::placeholder': { color: '#9ca3af' }
            }
          }
        });

        // NOTE: Link suppression temporarily disabled per request; allowing native Stripe Link UI to render.
        // To re-enable previous suppression logic, restore the removed IIFE here.
        cardElement.mount('#card-element');
        cardElement.on('ready', () => {
          try {
            console.log('[Stripe] Card element ready. Live mode:', USING_LIVE);
            // Ensure iframe really can receive input
            const iframe = document.querySelector('#card-element iframe');
            if(iframe){
              iframe.style.pointerEvents = 'auto';
              const cs = getComputedStyle(iframe);
              console.log('[Stripe][IframeStyles]', { pointerEvents: cs.pointerEvents, opacity: cs.opacity, zIndex: cs.zIndex });
            }
          } catch(e) { console.warn('Post-mount adjust error', e); }
          if (STRIPE_DEBUG) initStripeDebug();
        });

        // ===== Debug Instrumentation (Option 2) =====
        function initStripeDebug(){
          const cardHost = document.getElementById('card-element');
          if(!cardHost){ console.warn('[StripeDebug] #card-element not found.'); return; }
          // Panel
          const panel = document.createElement('div');
          panel.id='stripe-debug-panel';
          panel.innerHTML = `
            <style>
              #stripe-debug-panel{position:fixed;bottom:8px;left:8px;background:#141519;z-index:2000;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-family:Inter,system-ui,Arial;font-size:11px;line-height:1.35;max-width:280px;color:#cbd1d8;box-shadow:0 6px 20px -4px rgba(0,0,0,.6)}
              #stripe-debug-panel h5{margin:0 0 6px;font-size:12px;font-weight:800;color:#f3f4f6}
              #stripe-debug-panel button{background:#0f1012;border:1px solid var(--border);color:#e5e7eb;font-size:11px;padding:4px 8px;border-radius:6px;cursor:pointer;margin:4px 4px 0 0}
              #stripe-debug-panel .row{display:flex;flex-wrap:wrap;gap:4px;margin-top:4px}
              #stripe-debug-focus-ring{position:fixed;pointer-events:none;border:2px solid #f59e0b;box-shadow:0 0 0 3px rgba(245,158,11,.35);z-index:1999;transition:all .15s ease;}
              #stripe-debug-ray{position:fixed;width:1px;background:rgba(245,158,11,.65);z-index:1998;pointer-events:none}
              #stripe-debug-log{max-height:120px;overflow:auto;background:#0f1012;border:1px solid rgba(255,255,255,.08);padding:4px 6px;border-radius:6px;margin-top:6px;font-family:ui-monospace,monospace;font-size:10px;white-space:pre-wrap;}
            </style>
            <h5>Stripe Debug</h5>
            <div><strong>Mode:</strong> ${USING_LIVE? 'LIVE' : 'TEST'} | <strong>Host:</strong> ${HOST}</div>
            <div><strong>Key:</strong> ${STRIPE_PUBLISHABLE_KEY.slice(0,10)}…</div>
            <div class="row">
              <button id="dbgToggleOverlay">Hide Overlay</button>
              <button id="dbgElements">ElementsAtCenter</button>
              <button id="dbgPersist">Persist=Off</button>
              <button id="dbgDisable">Disable Debug</button>
            </div>
            <div id="stripe-debug-log"></div>
            <div style="margin-top:4px;opacity:.65">Shortcuts: Alt+Shift+D (toggle overlay) • Alt+Shift+L (Link suppress) </div>
          `;
          document.body.appendChild(panel);
          const logBox = panel.querySelector('#stripe-debug-log');
          function log(msg,obj){
            const time = new Date().toLocaleTimeString();
            logBox.textContent = `[${time}] ${msg}\n` + logBox.textContent.slice(0,6000);
            if(obj) console.debug('[StripeDebug]', msg, obj);
          }
          // Focus ring overlay
          const ring = document.createElement('div');
            ring.id='stripe-debug-focus-ring';
          document.body.appendChild(ring);
          const ray = document.createElement('div'); ray.id='stripe-debug-ray'; document.body.appendChild(ray);
          let overlayVisible = true;
          function positionRing(){
            const ifr = cardHost.querySelector('iframe');
            if(!ifr){ ring.style.display='none'; return; }
            const r = ifr.getBoundingClientRect();
            ring.style.display='block';
            ring.style.left = r.left+'px';
            ring.style.top = r.top+'px';
            ring.style.width = r.width+'px';
            ring.style.height = r.height+'px';
            // Ray through center
            const cx = r.left + r.width/2;
            ray.style.left = cx+'px';
            ray.style.top = r.top+'px';
            ray.style.height = r.height+'px';
          }
          positionRing();
          window.addEventListener('resize', positionRing);
          const persistBtn = panel.querySelector('#dbgPersist');
          let persist = false;
          function elementsAtCenter(){
            const ifr = cardHost.querySelector('iframe');
            if(!ifr){ log('No iframe yet'); return; }
            const r = ifr.getBoundingClientRect();
            const x = r.left + r.width/2;
            const y = r.top + r.height/2;
            const els = document.elementsFromPoint(x,y).map(e=>e.tagName+(e.id?('#'+e.id):'')+(e.className?('.'+String(e.className).split(/\s+/).join('.')):''));
            log('elementsFromPoint center => '+els.join(' -> '));
          }
          // Buttons
          panel.querySelector('#dbgToggleOverlay').onclick=()=>{
            overlayVisible=!overlayVisible;
            ring.style.display = overlayVisible?'block':'none';
            ray.style.display = overlayVisible?'block':'none';
            panel.querySelector('#dbgToggleOverlay').textContent = overlayVisible?'Hide Overlay':'Show Overlay';
            log('Overlay '+(overlayVisible?'shown':'hidden'));
          };
          panel.querySelector('#dbgElements').onclick=elementsAtCenter;
          persistBtn.onclick=()=>{ persist=!persist; persistBtn.textContent = 'Persist='+(persist?'On':'Off'); log('Persist '+(persist?'ENABLED':'disabled')); };
          panel.querySelector('#dbgDisable').onclick=()=>{ localStorage.removeItem('stripeDebug'); location.reload(); };
          // Auto persist logging (every 2s) if enabled
          setInterval(()=>{ if(persist) elementsAtCenter(); },2000);
          // Shortcut Alt+Shift+D
          window.addEventListener('keydown',e=>{ if(e.altKey && e.shiftKey && e.code==='KeyD'){ panel.querySelector('#dbgToggleOverlay').click(); }});
          // Observe pointer-events / overlay blockers
          const obs = new MutationObserver(()=>{ elementsAtCenter(); });
          obs.observe(document.body,{subtree:true,attributes:true,attributeFilter:['style','class']});
          // Expose debug API
          window.__stripeDebug = { elementsAtCenter, log, panel };
          log('Debug panel initialized.');
          // If Link suppression was previously installed (should not in debug), note status
          log('Link suppression active? '+(window.__linkSuppressEnabled?'YES':'NO'));
        }
        // Provide a way to enable debug on the fly (console helper)
        window.enableStripeDebug = function(){ localStorage.setItem('stripeDebug','1'); location.reload(); };
        window.disableStripeDebug = function(){ localStorage.removeItem('stripeDebug'); location.reload(); };
      }

      renderMain();
    })();
  </script>

  <!-- Version Info Constants -->
  <script>
    // Dynamic version info (fallback values)
    let VERSION = "v2.4.0";
    let BUILD_DATE = "2025-10-04";
    let BUILD_INFO = "Email-first Stripe lookup + dynamic API base + live publishable key + saved card surfacing";
    const ADMIN_PIN = "2468";
    fetch('version.json',{cache:'no-store'})
      .then(r=>r.ok?r.json():null)
      .then(v=>{ if(!v) return; VERSION='v'+v.version; BUILD_DATE=(v.buildDate||'').slice(0,10); BUILD_INFO=v.notes||BUILD_INFO; const vd=document.getElementById('versionDisplay'); if(vd) vd.textContent=VERSION; })
      .catch(()=>{});
  </script>

  <!-- Admin Panel HTML -->
  <button id="adminFab" title="Admin" style="position:fixed;right:16px;bottom:16px;width:56px;height:56px;border-radius:999px;border:1px solid rgba(255,255,255,.2);background:#0f0f10;color:#fff;font-size:24px;cursor:pointer;box-shadow:0 10px 22px rgba(0,0,0,.6)">⚙️</button>

  <div id="adminModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.75);z-index:10000;align-items:center;justify-content:center">
    <div id="adminPanel" style="background:linear-gradient(180deg,#17181c,#101113);color:#eee;border:1px solid rgba(255,255,255,.25);border-radius:16px;padding:18px;width:min(320px,85vw);max-height:70vh;overflow-y:auto;box-shadow:0 10px 30px rgba(0,0,0,.8)">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <h3 style="margin:0;font-size:20px;font-weight:800;color:#f3f4f6;">Payment System Admin</h3>
      </div>
      <p style="margin:6px 0 8px;opacity:.8;font-size:14px;color:#c9cacc">Enter PIN to view system info.</p>

      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0">
        <input id="adminPin" type="password" placeholder="PIN" style="padding:10px;border:1px solid rgba(255,255,255,.2);border-radius:8px;background:#0f1012;color:#fff;flex:1;min-width:100px">
        <button id="adminUnlock" style="padding:10px 16px;border:1px solid #4ade80;border-radius:8px;background:#166534;color:#bbf7d0;cursor:pointer">Unlock</button>
        <span id="pinMsg" style="color:#ff9aa1;display:none;font-size:12px">Wrong PIN</span>
        <button id="adminClose" style="padding:10px 16px;border:1px solid #ef4444;border-radius:8px;background:#991b1b;color:#fecaca;cursor:pointer;margin-left:auto">Close</button>
      </div>

      <div id="adminBody" style="display:none">
        <!-- Version Info Section -->
        <div style="border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:12px;margin-top:12px">
          <h4 style="margin:4px 0 6px;color:#eee">System Info</h4>
          <div style="font-size:12px;color:#c9cacc;line-height:1.4">
            <div><strong>Version:</strong> <span id="versionDisplay">v2.4.0</span></div>
            <div><strong>Environment:</strong> <span id="environmentDisplay">Loading...</span></div>
            <div><strong>Last Updated:</strong> <span id="lastUpdatedDisplay">Jan 2025</span></div>
            <div><strong>Page:</strong> Payment Options</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Admin Panel JavaScript -->
  <script>
    (function() {
      const adminFab = document.getElementById('adminFab');
      const adminModal = document.getElementById('adminModal');
      const adminClose = document.getElementById('adminClose');
      const adminPin = document.getElementById('adminPin');
      const adminUnlock = document.getElementById('adminUnlock');
      const pinMsg = document.getElementById('pinMsg');
      const adminBody = document.getElementById('adminBody');

      function $admin(id) { return document.getElementById(id); }

      adminFab.onclick = () => {
        adminModal.style.display = "flex";
        document.body.style.overflow = "hidden";
        pinMsg.style.display = "none";
        adminBody.style.display = "none";
        adminPin.value = "";
        adminPin.focus();
      };

      adminClose.onclick = () => {
        adminModal.style.display = "none";
        document.body.style.overflow = "";
      };

      adminUnlock.onclick = () => {
        if (adminPin.value === ADMIN_PIN) {
          pinMsg.style.display = "none";
          adminBody.style.display = "block";
          updateVersionDisplay();
        } else {
          pinMsg.style.display = "inline";
          adminBody.style.display = "none";
        }
      };

      function updateVersionDisplay() {
        $admin("versionDisplay").textContent = VERSION;
        $admin("lastUpdatedDisplay").textContent = BUILD_DATE;
        
        // Detect environment
        let env = "Unknown";
        if (DEV) env = "Development (localhost)";
        else if (TEST) env = "Test (test.tablet.msbdance.com)";
        else env = "Production (tablet.msbdance.com)";
        
        $admin("environmentDisplay").textContent = env;
      }

      // Allow Enter key to unlock
      adminPin.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          adminUnlock.click();
        }
      });
    })();
  </script>

</body>
</html>
