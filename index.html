<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Check In Tablet System</title>
  
  <!-- =============================== [SECTION: STYLES] (rarely changes) =============================== -->
  <style>
    :root{ --gold1:#f3dc8a; --gold2:#b8922a; --text:#f3f4f6; --muted:#c9cacc; }
    html,body{ height:100%; }
    body{ margin:0; background:#0f0f10; color:var(--text); font-family:Inter,system-ui,Arial; }

    .stage{
      min-height:100vh; display:flex; align-items:center; justify-content:center;
      background: radial-gradient(1200px 600px at 30% 10%, #1e1f23 0%, #0f1012 55%, #0c0d0f 100%);
    }
    .stack{ 
      width:min(960px,92%); text-align:center; padding:32px 12px 32px; 
      position:relative; 
      min-height:80vh;
      display:flex;
      flex-direction:column;
      justify-content:center;
    }

    .brand{ width:92px;height:92px;margin:0 auto 14px; border-radius:20px; overflow:hidden; }
    .brand img{ width:100%; height:100%; object-fit:contain; display:block; }

    h1{ margin:0 0 6px; font-size:clamp(32px,6.4vw,56px); font-weight:900; letter-spacing:.3px; }
    .sub{ color:var(--muted); margin:0 0 26px; font-size:clamp(14px,2.6vw,18px); }

    .btn{
      display:flex; align-items:center; justify-content:center; gap:12px;
      width:100%; height:84px; border-radius:10px; border:1px solid rgba(243,244,246,0.2); cursor:pointer;
      font-weight:600; font-size:clamp(18px,3.8vw,24px);
      transition:all .2s ease;
      position:relative; overflow:hidden; touch-action:manipulation;
      box-shadow:0 2px 4px rgba(0,0,0,0.1);
      background:transparent; color:#e5e7eb;
    }
    .btn:hover:not(.btn-disabled){
      transform:translateY(-2px);
      box-shadow:0 4px 16px rgba(0,0,0,.2);
      background:rgba(255,255,255,0.03);
    }
    .btn:active{ transform:scale(.98); }
    .btn-gold{ background:#d4af37; color:#1a1d1f; border:none; box-shadow:0 2px 8px rgba(212,175,55,0.3); }
    .btn-gold:hover:not(.btn-disabled){ box-shadow:0 4px 20px rgba(212,175,55,0.5); background:#d4af37; }
    .btn-dark{ background:#2a2d2f; color:#f3f4f6; border:1px solid var(--border); box-shadow:0 2px 4px rgba(0,0,0,0.1); }
    .btn-dark:hover:not(.btn-disabled){ box-shadow:0 4px 12px rgba(0,0,0,0.2); }
    .btn-disabled{ background:#2a2a2a !important; color:#bbb !important; cursor:not-allowed !important; opacity:.9; }

    /* Smooth slide-in animations for seamless transitions */
    .slide-in-element {
      opacity: 0;
      transform: translateY(30px);
      transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    .slide-in-element.animate {
      opacity: 1;
      transform: translateY(0);
    }
    
    /* Staggered animation delays - minimal for overlapping transition */
    .slide-in-element:nth-child(1) { transition-delay: 0s; }
    .slide-in-element:nth-child(2) { transition-delay: 0.05s; }
    .slide-in-element:nth-child(3) { transition-delay: 0.1s; }
    .slide-in-element:nth-child(4) { transition-delay: 0.15s; }
    .slide-in-element:nth-child(5) { transition-delay: 0.2s; }
    .slide-in-element:nth-child(6) { transition-delay: 0.25s; }
    
    /* Special animation for logo */
    .brand.slide-in-element {
      transform: translateY(20px) scale(0.9);
    }
    
    .brand.slide-in-element.animate {
      transform: translateY(0) scale(1);
    }
    
    /* Special animation for title */
    h1.slide-in-element {
      transform: translateY(25px);
      letter-spacing: 2px;
    }
    
    h1.slide-in-element.animate {
      transform: translateY(0);
      letter-spacing: 0.3px;
    }
    
    /* Success screen animations */
    .success-title.celebrate {
      opacity: 1 !important;
      transform: translateY(0) scale(1.05) !important;
      transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    .success-detail.celebrate {
      opacity: 1 !important;
      transform: translateY(0) !important;
      transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) 0.2s;
    }
    
    .success-countdown.celebrate {
      opacity: 1 !important;
      transform: translateY(0) !important;
      transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) 0.4s;
    }
    
    .success-button.celebrate {
      opacity: 1 !important;
      transform: translateY(0) !important;
      transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) 0.6s;
    }
    
    /* Success screen animations */
    .success-title.celebrate {
      opacity: 1 !important;
      transform: translateY(0) scale(1.05) !important;
      transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    .success-detail.celebrate {
      opacity: 1 !important;
      transform: translateY(0) !important;
      transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) 0.2s;
    }
    
    .success-countdown.celebrate {
      opacity: 1 !important;
      transform: translateY(0) !important;
      transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) 0.4s;
    }
    
    .success-button.celebrate {
      opacity: 1 !important;
      transform: translateY(0) !important;
      transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) 0.6s;
    }
    
    /* Instant loading animation for visual continuity */
    .instant-loader {
      position: fixed;
      inset: 0;
      background: radial-gradient(1200px 600px at 30% 10%, #1e1f23 0%, #0f1012 55%, #0c0d0f 100%);
      z-index: 8888;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 1;
      transition: opacity 0.4s ease-out;
    }
    
    .instant-loader.fade-out {
      opacity: 0;
      pointer-events: none;
    }
    
    .loading-pulse {
      height: 60px;
      aspect-ratio: 2;
      border-bottom: 3px solid #0000;
      background: 
        linear-gradient(90deg, #ffffff 50%, #0000 0)
        -25% 100%/50% 3px repeat-x border-box;
      position: relative;
      animation: bounceTrack 0.75s linear infinite;
    }
    
    .loading-pulse:before {
      content: "";
      position: absolute;
      inset: auto 42.5% 0;
      aspect-ratio: 1;
      border-radius: 50%;
      background: linear-gradient(90deg, #d4af37, #f3dc8a);
      animation: bounceBall 0.75s cubic-bezier(0, 900, 1, 900) infinite;
    }
    
    @keyframes bounceTrack {
      to { background-position: -125% 100%; }
    }
    
    @keyframes bounceBall {
      0%, 2% { bottom: 0%; }
      98%, to { bottom: 0.1%; }
    }

    .input{
      width:100%; max-width:420px; margin:0 auto; padding:18px 20px;
      background:#0f1012; color:#fff; border:1px solid rgba(255,255,255,.12);
      border-radius:14px; font-size:clamp(18px,3.8vw,24px); outline:none;
      transition:all .3s ease, transform .2s ease;
    }
    .input:focus{
      border-color:rgba(243,220,138,.4);
      box-shadow:0 0 0 3px rgba(243,220,138,.1);
      transform:translateY(-1px);
    }

    @keyframes shake { 0%{transform:translateX(0)}20%{transform:translateX(-6px)}
      40%{transform:translateX(6px)}60%{transform:translateX(-6px)}
      80%{transform:translateX(6px)}100%{transform:translateX(0)} }
    .input-error{ animation:shake .35s ease; border-color:#ff6b6b !important; }

    .chip{
      padding:22px 26px; border-radius:999px; border:1px solid rgba(255,255,255,.12);
      background:#121316; color:#eee; font-weight:800; cursor:pointer; text-align:center;
      width:min(860px,100%); margin:0 auto; position:relative; overflow:hidden; touch-action:manipulation;
      font-size:clamp(20px, 4.6vw, 30px); line-height:1.15;
    }
    .chip.sel{ background:linear-gradient(180deg,var(--gold1),var(--gold2)); color:#1b1400; }

  /* Locked state after successful check-in */
  .chip.checked{
    background: #1f2d1f !important;      /* soft green bg */
    color:#9ae6b4 !important;             /* light green text */
    border-color: rgba(154,230,180,.35) !important;
  }
  .chip:disabled{
    cursor:not-allowed !important;
    opacity:.88;
  }

    .screen{ 
      display:none; opacity:0; transform:translateX(30px); 
      transition:all .5s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
      position:absolute; 
      width:100%; 
      z-index:1;
    }
    .screen.show{ 
      display:block; opacity:1; transform:translateX(0); 
      z-index:2;
    }
    .screen.slide-out-left{ 
      opacity:0; transform:translateX(-30px); 
      transition:all .4s cubic-bezier(0.55, 0.06, 0.68, 0.19); 
      z-index:1;
    }
    .screen.slide-out-right{ 
      opacity:0; transform:translateX(30px); 
      transition:all .4s cubic-bezier(0.55, 0.06, 0.68, 0.19); 
      z-index:1;
    }
    .screen.exit{ 
      opacity:0; transform:translateY(-8px); 
      transition:all 1.2s cubic-bezier(0.4, 0, 0.2, 1); 
    }

    #adminModal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.75); z-index:10000;
                 align-items:center; justify-content:center; }
    #adminPanel{ background:linear-gradient(180deg,#17181c,#101113); color:#eee;
                 width:min(350px,85vw); max-height:88vh; overflow:auto;
                 border:1px solid rgba(255,255,255,.15); border-radius:16px; padding:16px; 
                 box-shadow:0 10px 30px rgba(0,0,0,.8); text-align:center;
                 transition:width 0.3s ease, max-width 0.3s ease; }
    #adminPanel.expanded{ width:min(920px,94%); text-align:left; }
    .pill{ padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12);
           background:rgba(255,255,255,.06); font-size:12px; }
    .admin-row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:10px 0; justify-content:flex-start; }
    .admin-section{ border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:14px; margin-top:14px; }

    .day-card{ border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:10px; margin-top:10px; }
    .day-header{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .class-row{ display:flex; gap:6px; margin:6px 0; }
    .class-row input{ flex:1; padding:10px; border:1px solid rgba(255,255,255,.2); background:#0f1012; color:#fff; border-radius:8px; }
    .icon-btn{ padding:8px 10px; border:0; border-radius:8px; cursor:pointer; font-size:14px; }
    .add-btn{ background:linear-gradient(180deg,var(--gold1),var(--gold2)); color:#1b1400; font-weight:800; }
    .del-btn{ background:#0f1012; color:#eee; border:1px solid rgba(255,255,255,.2); }
    .sync-badge{ padding:6px 10px; border-radius:999px; font-size:12px; font-weight:700; }
    .sync-ok{ background:#0f2f1a; color:#8ef0b0; border:1px solid #1e6a3a; }
    .sync-bad{ background:#2f0f12; color:#ff9aa1; border:1px solid #7a2229; }

    .gold-icon { color: var(--gold1); fill: currentColor; }

    .ripple { position:absolute; border-radius:9999px; transform:scale(0); opacity:.45; pointer-events:none; animation:ripple-burst .28s ease-out forwards; }
    .btn-dark .ripple, .chip .ripple, .nkey .ripple { background: rgba(255,255,255,.35); }
    .btn-gold .ripple { background: rgba(0,0,0,.35); }
    @keyframes ripple-burst { to { transform:scale(6); opacity:0; } }

    .btn-sm{ height:52px; font-size:clamp(16px,3vw,20px); border-radius:12px; }

    .nf{ width:min(760px,100%); margin:0 auto; max-height:0; overflow:hidden; transition:max-height 280ms ease, margin-top 280ms ease; }
    .nf.open{ margin-top:10px; max-height:220px; }
    .nf-text{ color:#c9cacc; text-align:center; font-size:clamp(13px,2.4vw,16px); margin:6px 0 8px; }
    .nf-actions{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width:480px){ .nf-actions{ grid-template-columns:1fr; } }
    .error-message{opacity:0;transform:translateY(-6px);transition:opacity 180ms ease,transform 180ms ease;}
    .secondary-buttons{opacity:0;transform:translateY(10px);transition:opacity 260ms ease-out,transform 260ms ease-out;}
    .reveal{opacity:1 !important;transform:translateY(0) !important;}
    .back-button{ height:84px; font-size:clamp(18px,3.8vw,26px); border-radius:16px;
      transition: transform 280ms cubic-bezier(0.25, 0.46, 0.45, 0.94), height 280ms ease-in-out, font-size 280ms ease-in-out, border-radius 280ms ease-in-out, margin-top 280ms ease-in-out, opacity 200ms ease; }
    .back-button.shrink{ height:52px; font-size:clamp(16px,3vw,20px); border-radius:12px; transform:translateY(6px) scale(0.96); opacity:0.95; }
    .back-button:hover:not(.shrink){ transform:translateY(-2px) scale(1.02); }
    @media (prefers-reduced-motion: reduce){ .error-message,.secondary-buttons,.back-button,.nf{transition:none !important;} }

    /* ===== Polished Number Pad ===== */
    .numpad{
      width:100%;
      max-width:420px;           /* centers & limits width */
      margin:14px auto 0;        /* center under input */
      display:grid;
      grid-template-columns: repeat(3, minmax(104px, 1fr));
      gap:12px;
      justify-items:stretch;
    }
    .nkey{
      height:84px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#2a2d2f;
      color:#f3f4f6;
      font-weight:600;
      font-size:clamp(22px,4.8vw,30px);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      box-shadow:0 2px 4px rgba(0,0,0,0.1);
      transition:all .2s ease;
      position:relative; overflow:hidden; touch-action:manipulation;
      opacity:0; transform:translateY(15px) scale(0.9);
    }
    .nkey.animate-in{
      opacity:1 !important; transform:translateY(0) scale(1) !important;
    }
    .nkey:hover{
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
      background:#35383a;
    }
    .nkey:active{ transform:scale(.98); }
    .nkey.muted{ opacity:.9; }
    .nkey::after{
      content:""; position:absolute; inset:0;
      background: radial-gradient(120% 120% at 50% -20%, rgba(255,255,255,.12), transparent 60%);
      pointer-events:none;
      border-radius:inherit;
    }

    /* small, quiet, centered link-style button */
    .minor-row{ display:flex; justify-content:center; margin-top:10px; }
    .link-btn{
      background:transparent; border:0; cursor:pointer;
      color:var(--muted); font-weight:700; font-size:clamp(14px,2.6vw,16px);
      padding:6px 10px; border-radius:10px;
      transition: color .15s, background .15s;
    }
    .link-btn:hover{ color:var(--gold1); background:rgba(255,255,255,.06); }

    .pad-host{ width:100%; max-width:420px; margin:14px auto 0; }
  </style>
</head>
<body>
  <div id="app"></div>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>



  <script>
  /* =============================== [SECTION: SETTINGS] (you change these) =============================== */
  /* Version will be loaded dynamically from version.json (fallbacks below) */
  let VERSION = "v2.6.0"; // fallback until fetch resolves
  let BUILD_DATE = "2025-10-06"; // ISO fallback
  let BUILD_INFO = "Membership tiers + UI redesign";
  fetch('version.json',{cache:'no-store'})
    .then(r=>r.ok?r.json():null)
    .then(meta=>{ if(!meta) return; VERSION='v'+meta.version; BUILD_DATE=(meta.buildDate||'').replace('T',' ').replace('Z',''); BUILD_INFO=meta.notes||BUILD_INFO; const vEl=document.getElementById('adminVersion'); if(vEl) vEl.textContent=VERSION; })
    .catch(()=>{});
  
  const DEV =
    location.hostname === 'localhost' ||
    location.hostname === '127.0.0.1' ||
    location.hostname === '0.0.0.0' ||
    location.hostname === '::1' ||
    location.protocol === 'file:'; // Auto toggle based on environment

  const TEST = location.hostname === 'test.tablet.msbdance.com';

  const CONFETTI = !DEV;
  const RIPPLE   = !DEV;
  const COUNTDOWN_SEC = 8;

  const LOGO_URL = "https://storage.googleapis.com/msgsndr/3RfSeF58PmlwTx5aIQ0a/media/68cb7c7d10510f54a333c881.svg";

/* === URLS (switch by DEV/TEST) ===
     - Main/home (where the tablet starts):
         DEV  ‚Üí ./index.html
         TEST ‚Üí https://test.tablet.msbdance.com/
         PROD ‚Üí https://tablet.msbdance.com/
     - Options page:
         DEV  ‚Üí ./options.html
         TEST ‚Üí https://test.tablet.msbdance.com/options.html
         PROD ‚Üí https://tablet.msbdance.com/options.html
  */
  const HOME_URL = DEV
    ? "./index.html"
    : TEST
    ? "https://test.tablet.msbdance.com/"
    : "https://tablet.msbdance.com/";

  const DROPIN_RETURN_URL = DEV
    ? "./options.html"
    : TEST
    ? "https://test.tablet.msbdance.com/options.html"
    : "https://tablet.msbdance.com/options.html";

  const MEMBER_RETURN_URL = DEV
    ? "./member-options.html"
    : TEST
    ? "https://test.tablet.msbdance.com/member-options.html"
    : "https://tablet.msbdance.com/member-options.html";

  const DROPIN_NEW_URL = DROPIN_RETURN_URL;

/* Apps Script (unchanged) */
  const SYNC_URL = "https://script.google.com/macros/s/AKfycbwoHg_YaLdOxp_DL50Y2JiQ_xkF005eEFqyNqjBGCo1ONLWA37fsfbg-gd-BhYb5c26/exec";
  const ADMIN_PIN = "2468";
  const LOG_URL   = SYNC_URL;



  /* Default data (cloud can override) */
  let SCHEDULE = { sun:[], mon:["Salsa Basics","Beginner Salsa","Beginner Bachata"], tue:["Salsa Basics","Beginner Salsa","Salsa Shines Lvl 2","Afrobeats","Beginner Salsa Plus"], wed:["Salsa Shines Level 1","Sensual Bachata Body Movement","Beginner Salsa Plus","Advanced Beginner Salsa"], thu:["Bachata Shines","Beginner Bachata","Advanced Beginner Bachata","Sensual Bachata Partnerwork"], fri:[], sat:[] };
  // Ensure MEMBERS exists even if loaded from cloud later (Make.com is used for verification; this is for legacy/logging safety)
  let MEMBERS = [];

  const DAY_KEYS=["sun","mon","tue","wed","thu","fri","sat"];
  const $ = s => document.querySelector(s);
  const log = (...a)=> DEV && console.log("[TAB]", ...a);

  /* =============================== [SECTION: HELPERS] (rarely changes) =============================== */
  const digits10 = s => String(s||"").replace(/\D/g,"").slice(-10);
  const todayKey = () => DAY_KEYS[new Date().getDay()];
  const normPhone = s => String(s||"").replace(/\D/g,"").slice(-10);

  /* ===== Phone format + Numpad ===== */
  function formatPhonePretty(raw10){
    const d = String(raw10||"").replace(/\D/g,"").slice(0,10);
    if (d.length <= 3) return d;
    if (d.length <= 6) return `(${d.slice(0,3)}) ${d.slice(3)}`;
    return `(${d.slice(0,3)}) ${d.slice(3,6)}-${d.slice(6)}`;
  }
  function mountNumpad(forInputId){
    const host = document.querySelector(`[data-for="${forInputId}"]`);
    const input = document.getElementById(forInputId);
    if(!host || !input) return;

    // clear any previously mounted pad
    host.innerHTML = "";

    // keep system keyboard hidden
    input.setAttribute("readonly","readonly");
    input.addEventListener("focus", () => { input.setAttribute("readonly","readonly"); });

    const makeKey = (label, cls="", onTap=null) => {
      const b = document.createElement("button");
      b.type = "button"; b.className = `nkey ${cls}`; b.textContent = label;
      b.addEventListener("click", () => onTap && onTap());
      return b;
    };

    function setDigits(newDigits){
      const cleaned = String(newDigits||"").replace(/\D/g,"").slice(0,10);
      input.dataset.digits = cleaned;
      input.value = formatPhonePretty(cleaned);
      input.dispatchEvent(new Event("input", {bubbles:true}));
    }

    // seed with existing value (if any)
    setDigits(input.dataset.digits || digits10(input.value||""));

    // build pad grid
    const grid = document.createElement("div");
    grid.className = "numpad";
    host.appendChild(grid);

    const push  = (n) => () => setDigits((input.dataset.digits||"") + String(n));
    const back  = () => setDigits((input.dataset.digits||"").slice(0,-1));
    const clear = () => setDigits("");

    [1,2,3,4,5,6,7,8,9].forEach(n=> grid.appendChild(makeKey(String(n), "", push(n))));
    grid.appendChild(makeKey("C", "muted", clear));
    grid.appendChild(makeKey("0", "", push(0)));
    grid.appendChild(makeKey("‚å´", "muted", back));
  }



  /* =============================== [SECTION: CLOUD SYNC] (sometimes changes) =============================== */
  /* JSONP (for Apps Script) */
  function jsonp(url){
    return new Promise(res=>{
      const cb='cb_'+Math.random().toString(36).slice(2);
      window[cb]=r=>{ try{delete window[cb]}catch(e){} script.remove(); res(r); };
      const script=document.createElement('script');
      script.src = url + (url.includes('?')?'&':'?') + 'callback='+cb;
      script.onerror = ()=>{ try{delete window[cb]}catch(e){} script.remove(); res({ok:false}); };
      document.body.appendChild(script);
    });
  }
  const loadCloud = ()=>jsonp(`${SYNC_URL}?action=load`);
  const saveMembersCloud = (m)=>jsonp(`${SYNC_URL}?action=saveMembers&data=${encodeURIComponent(JSON.stringify(m))}`);
  const saveScheduleCloud = (s)=>jsonp(`${SYNC_URL}?action=saveSchedule&data=${encodeURIComponent(JSON.stringify(s))}`);

  function logCheckin(phone, name, classesCsv) {
    const u = `${SYNC_URL}?phone=${encodeURIComponent(phone)}&name=${encodeURIComponent(name)}&classes=${encodeURIComponent(classesCsv)}`;
    return jsonp(u).then(r => !!(r && r.ok));
  }

  function setSyncBadge(state,msg){
    const b=$("#syncBadge"); if(!b) return;
    if(state==="ok"){ b.textContent=msg||"Synced ‚úì"; b.className="sync-badge sync-ok"; }
    else if(state==="bad"){ b.textContent=msg||"Offline"; b.className="sync-badge sync-bad"; }
    else { b.textContent="‚Ä¶"; b.className="sync-badge"; }
  }

  /* =============================== [SECTION: GHL WEBHOOK HELPER] =============================== */
  /** Member check-in webhook (GHL) */
  const GHL_WEBHOOK_MEMBER_URL =
    "https://services.leadconnectorhq.com/hooks/3RfSeF58PmlwTx5aIQ0a/webhook-trigger/73c401de-04b7-477b-b7c6-8efa0792a5a3";

  async function sendGHLMemberCheckin({ phone, name, classes }) {
    // Send to GHL (existing integration)
    if (GHL_WEBHOOK_MEMBER_URL && phone) {
      const qp = new URLSearchParams();
      qp.set("evt", "member_checkin");
      qp.set("phone", String(phone).replace(/\D/g,"").slice(-10));
      if (name) qp.set("name", name);

      // Always send class1..class5
      const arr = Array.isArray(classes) ? classes.slice(0, 5) : [];
      while (arr.length < 5) arr.push("");
      for (let i = 0; i < 5; i++) qp.set(`class${i+1}`, arr[i]);

      // Extras
      qp.set("classCount", String((classes || []).length));
      qp.set("classesCsv", (classes || []).join(", "));
      qp.set("ts", String(Date.now()));

      let sent = false;
      try {
        if (navigator.sendBeacon) {
          const body = new URLSearchParams(qp);
          sent = navigator.sendBeacon(GHL_WEBHOOK_MEMBER_URL, body);
        }
      } catch (_) {}

      if (!sent) {
        try {
          const img = new Image();
          img.referrerPolicy = "no-referrer";
          img.src = `${GHL_WEBHOOK_MEMBER_URL}?${qp.toString()}`;
        } catch (_) {}
      }

      try { if (typeof DEV !== "undefined" && DEV) console.log("[GHL] Sent member check-in", Object.fromEntries(qp)); } catch (_){}
    }

    // Also send to CRM (send directly to CRM webhook like GHL)
    try {
      const nameParts = (name || 'Member').split(' ');
      const CRM_WEBHOOK_URL = 'https://test.mydancedesk.com/api/webhooks/tablet/check-in';
      
      console.log('üì§ [CRM] Sending check-in directly to CRM webhook...', { phone, classes });
      
      // Send each class as a separate check-in (like GHL does)
      for (const className of classes) {
        const response = await fetch(CRM_WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            phone: String(phone).replace(/\D/g,"").slice(-10),
            first_name: nameParts[0] || 'Member',
            last_name: nameParts.slice(1).join(' ') || '',
            class_name: className,
            checked_in_at: new Date().toISOString(),
            notes: `Member check-in from tablet - ${className}`
          })
        });
        
        console.log(`üì• [CRM] Response for ${className}:`, response.status, response.statusText);
        
        if (response.ok) {
          const result = await response.json();
          console.log(`‚úÖ [CRM] Check-in synced: ${className}`, result);
        } else {
          const errorText = await response.text();
          console.error(`‚ùå [CRM] Check-in failed for ${className}:`, response.status, errorText);
        }
      }
    } catch (crmError) {
      console.error("[CRM] Failed to sync check-in (continuing anyway):", crmError);
    }
  }


  /* =============================== [SECTION: DROP-IN WEBHOOK HELPER] =============================== */
  // Helper to extract a name from potentially nested webhook responses
  function extractNameDeep(obj){
    const result = { name: "", firstName: "", lastName: "" };
    const seen = new Set();
    function pick(o){
      if(!o || typeof o !== 'object' || seen.has(o)) return;
      seen.add(o);
      const nameFields = ['name','fullName','full_name','displayName'];
      for (const k of nameFields){
        const v = o[k];
        if (typeof v === 'string' && v.trim()){ result.name ||= v.trim(); }
      }
      const fn = o.firstName || o.first_name || o.firstname;
      const ln = o.lastName  || o.last_name  || o.lastname;
      if (!result.firstName && typeof fn === 'string' && fn.trim()) result.firstName = fn.trim();
      if (!result.lastName  && typeof ln === 'string' && ln.trim()) result.lastName  = ln.trim();

      // Recurse into common containers/keys
      const children = [o.contact, o.person, o.customer, o.user, o.data, o.payload, o.result, o.response];
      children.forEach(pick);
      if (Array.isArray(o.items)) o.items.forEach(pick);
      if (Array.isArray(o.bundles)) o.bundles.forEach(b=> pick(b && (b.payload || b.data || b)));
      if (Array.isArray(o)) o.forEach(pick);
    }
    pick(obj);
    if (!result.name){
      const full = `${result.firstName} ${result.lastName}`.trim();
      if (full) result.name = full;
    }
    return result;
  }

  // Verify drop-in - toggles between GHL and CRM
  const MAKE_WEBHOOK_URL = "https://hook.us1.make.com/7o1igxij7s24myaep5mtc5k6fvxunqh8";
  
  async function verifyDropIn(phone, { timeoutMs = 8000 } = {}){
    try {
      const d = String(phone||"").replace(/\D/g, "").slice(-10);
      console.log(`üé´ DROP-IN VERIFY START:`, { phone, normalized: d, length: d.length });
      
      if (d.length !== 10) {
        console.warn(`‚ö†Ô∏è Invalid phone length: ${d.length}`);
        return { exists:false };
      }
      
      const lookupSource = localStorage.getItem('contactLookupSource') || 'ghl';
      console.log(`üîç Lookup source: ${lookupSource}`);
      
      // Try CRM first if source is 'crm' or 'both'
      if (lookupSource === 'crm' || lookupSource === 'both') {
        try {
          console.log(`üìû Calling CRM for drop-in...`);
          const crmResult = await verifyViaCRM(d, 'checkdrop', timeoutMs);
          console.log(`üìä CRM result:`, crmResult);
          
          if (crmResult.exists) {
            console.log(`‚úÖ Found in CRM!`);
            return crmResult;
          }
          
          if (lookupSource === 'crm') {
            console.log(`‚ùå CRM-only mode, not found`);
            return { exists: false };
          }
          
          console.log(`‚è≠Ô∏è Not in CRM, falling back to GHL...`);
        } catch (err) {
          console.error(`üí• CRM lookup failed:`, err);
          if (lookupSource === 'crm') return { exists: false };
        }
      }
      
      // Use GHL (Make.com) if source is 'ghl' or fallback from 'both'
      console.log(`üåê Using GHL/Make.com...`);
      return await verifyViaGHLDropIn(d, timeoutMs);
    } catch (err) {
      console.error(`üí• DROP-IN VERIFY ERROR:`, err);
      return { exists:false };
    }
  }
  
  // Original GHL drop-in logic
  async function verifyViaGHLDropIn(phone, timeoutMs = 8000){
    try {
      const u = new URL(MAKE_WEBHOOK_URL);
      u.searchParams.set("product", "checkdrop");
      u.searchParams.set("phone", phone);

      try { if (typeof DEV !== "undefined" && DEV) console.log("[DROP] ‚Üí", u.toString()); } catch(_){ }

      const ctrl = new AbortController();
      const to = setTimeout(() => ctrl.abort("timeout"), timeoutMs);

      const resp = await fetch(u.toString(), { method: "GET", signal: ctrl.signal, cache: "no-store" });
      clearTimeout(to);

      if (!resp.ok) {
        try { if (typeof DEV !== "undefined" && DEV) console.warn("[DROP] non-200", resp.status); } catch(_){ }
        return { exists:false };
      }

      const ct = resp.headers.get("content-type") || "";
      let data;
      if (ct.includes("application/json")) {
        data = await resp.json();
      } else {
        const txt = await resp.text();
        try { data = JSON.parse(txt); } catch { data = { result: (txt||"").trim().toLowerCase() }; }
      }

      const exists = !!(data && (data.result === "yes" || data.ok === true));
      const { name, firstName, lastName } = extractNameDeep(data);
      const email = data.email || "";
      try { if (typeof DEV !== "undefined" && DEV) console.log("[DROP] resp", data, "‚Üí exists:", exists, "name:", name, firstName, lastName, "email:", email); } catch(_){ }
      return { exists, name, firstName, lastName, email };
    } catch (err) {
      return { exists:false };
    }
  }

  // CRM lookup via tablet's own PostgreSQL database
  async function verifyViaCRM(phone, product, timeoutMs = 8000){
    try{
      // Call Railway API server (not relative path, since we're on GitHub Pages)
      const API_BASE = 'https://test-msbd-tablet-system-production.up.railway.app';
      const endpoint = product === 'checkmember' ? '/lookup/member' : '/lookup/drop-in';
      const u = new URL(endpoint, API_BASE);
      u.searchParams.set("phone", phone);
      
      console.log(`üîç CRM Lookup Starting:`, {
        product,
        phone,
        endpoint,
        fullUrl: u.toString(),
        origin: window.location.origin
      });
      
      const ctrl = new AbortController();
      const to = setTimeout(() => ctrl.abort("timeout"), timeoutMs);
      
      const resp = await fetch(u.toString(), { method:"GET", signal: ctrl.signal, cache:"no-store" });
      clearTimeout(to);
      
      console.log(`üì° CRM Response:`, {
        status: resp.status,
        statusText: resp.statusText,
        ok: resp.ok,
        url: resp.url
      });
      
      if(!resp.ok) {
        console.error(`‚ùå CRM lookup failed: ${resp.status} ${resp.statusText}`);
        return { exists:false };
      }
      
      const data = await resp.json();
      console.log(`‚úÖ CRM Data received:`, data);
      
      // Same format as GHL/Make.com
      const exists = data.exists === true || data.ok === true;
      const name = data.name || `${data.firstName||''} ${data.lastName||''}`.trim();
      const classesTaken = Number(data.classesTaken || data.classCount || 0) || 0;
      
      const result = { exists, name, firstName: data.firstName, lastName: data.lastName, email: data.email, classesTaken };
      console.log(`üéØ CRM Final result:`, result);
      
      return result;
    }catch(err){ 
      console.error(`üí• CRM lookup exception:`, err);
      return { exists:false }; 
    }
  }


  /* =============================== [SECTION: RIPPLE + ACTION DELAY] (rarely changes) =============================== */
  let rippleBlockUntil = 0;
  function spawnRippleFromEvent(ev, target){
    if(!RIPPLE) return;
    if(Date.now() < rippleBlockUntil) return;
    if(!target || target.offsetParent === null) return;
    const rect = target.getBoundingClientRect();
    const size = Math.max(rect.width, rect.height);
    const clientX = (ev.touches && ev.touches[0]?.clientX) ?? ev.clientX ?? (rect.left + rect.width/2);
    const clientY = (ev.touches && ev.touches[0]?.clientY) ?? ev.clientY ?? (rect.top  + rect.height/2);
    const x = clientX - rect.left - size/2;
    const y = clientY - rect.top  - size/2;
    const r = document.createElement('span');
    r.className = 'ripple'; r.style.width = r.style.height = size + 'px';
    r.style.left = x + 'px'; r.style.top  = y + 'px';
    target.appendChild(r); r.addEventListener('animationend', () => r.remove());
  }
  if (RIPPLE){
    document.addEventListener('pointerdown', (e)=>{
      const t = e.target.closest('.btn, .chip, .nkey'); if (!t) return;
      spawnRippleFromEvent(e, t);
    }, {passive:true});
  }
  function withRippleDelay(el, action, delay=140){
    if(!el) return; // guard if element not found
    el.addEventListener('click', ()=>{
      if (RIPPLE && !DEV){
        rippleBlockUntil = Date.now() + delay + 240;
        setTimeout(action, delay);
      } else {
        action(); // instant in DEV
      }
    });
  }

  // Loading dots helpers (used on Next buttons)
  function showPulsingDots(btn){
    if(!btn) return;
    // clear any prior
    try{ removePulsingDots(btn); }catch(_){}
    const span = document.createElement('span');
    span.className = 'loading-dots';
    const frames = ['‚Ä¢','‚Ä¢‚Ä¢','‚Ä¢‚Ä¢‚Ä¢'];
    let i = 0;
    span.textContent = frames[i];
    const timer = setInterval(()=>{ i = (i+1) % frames.length; span.textContent = frames[i]; }, 280);
    btn.appendChild(span);
    btn._dotsTimer = timer;
    btn._dotsEl = span;
  }
  function removePulsingDots(btn, label){
    if(!btn) return;
    if(btn._dotsTimer){ try{ clearInterval(btn._dotsTimer); }catch(_){ } btn._dotsTimer = 0; }
    if(btn._dotsEl && btn._dotsEl.remove) btn._dotsEl.remove();
    if(typeof label === 'string') btn.textContent = label;
  }



  /* =============================== [SECTION: APP BOOT + HTML] (rarely changes) =============================== */
  // Add instant loading animation before DOMContentLoaded
  const instantLoader = document.createElement('div');
  instantLoader.className = 'instant-loader';
  instantLoader.id = 'instantLoader';
  instantLoader.innerHTML = '<div class="loading-pulse"></div>';
  document.body.appendChild(instantLoader);
  
  document.addEventListener("DOMContentLoaded", async ()=>{
    document.getElementById("app").innerHTML = `
      <div class="stage"><div class="stack">
        <!-- ========== [SECTION: SCREEN ‚Äì WELCOME] (UI text changes) ========== -->
        <div id="scr-welcome" class="screen show">
          <div class="brand slide-in-element">${LOGO_URL?`<img src="${LOGO_URL}" alt="logo" onerror="this.style.display='none'">`:""}</div>
          <h1 class="slide-in-element">WELCOME TO<br>MSBD STUDIO</h1>
          <p class="sub slide-in-element">Check in below <span class="gold-icon">‚Üì</span></p>
          <div style="display:grid; gap:14px; max-width:420px; width:100%; margin:0 auto;">
            <button id="btnDropin" class="btn btn-gold slide-in-element">üéü Drop-In Check-In</button>
            <button id="btnMember" class="btn btn-dark slide-in-element">
              <svg class="gold-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="26" height="26">
                <path d="M12 12c2.67 0 4.8-2.13 4.8-4.8S14.67 2.4 12 2.4 7.2 4.53 7.2 7.2 9.33 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8v2.4h19.2v-2.4c0-3.2-6.4-4.8-9.6-4.8z"/>
              </svg>
              Member Check-In
            </button>
          </div>
        </div>

        <!-- ========== [SECTION: SCREEN ‚Äì DROP-IN PHONE] (often changes) ========== -->
        <div id="scr-drop" class="screen">
          <h2 style="margin:10px 0 6px;font-size:clamp(24px,5.4vw,40px);font-weight:900;">Drop-In Phone Number</h2>
          <p class="sub" style="margin:0 0 14px;">Type your number.</p>

          <input id="inpDrop" class="input" type="tel" placeholder="(555) 123-4567" inputmode="none" readonly>
          <div id="padDrop" class="pad-host" data-for="inpDrop"></div>

          <div style="display:grid; gap:10px; max-width:420px; width:100%; margin:16px auto 0;">
            <button id="btnDropNext" class="btn btn-gold">Next</button>
          </div>

          <div id="dropNotFound" class="nf">
            <div id="dropErr" class="nf-text error-message">We didn‚Äôt find that number.</div>
            <div id="dropBtns" class="nf-actions secondary-buttons">
              <button id="btnDropImNew" class="btn btn-gold btn-sm">I‚Äôm new</button>
              <button id="btnDropRetry" class="btn btn-dark btn-sm">Try again</button>
            </div>
          </div>

          <div style="display:grid; gap:10px; max-width:420px; width:100%; margin:10px auto 0;">
            <button id="backDrop" class="btn btn-dark back-button">‚Üê Back</button>
          </div>

          <p id="msgDrop" style="display:none;color:#ff9aa1;margin-top:8px;"></p>
        </div>

        <!-- ========== [SECTION: SCREEN ‚Äì MEMBER PHONE] (often changes) ========== -->
        <div id="scr-phone" class="screen">
          <h2 style="margin:10px 0 6px;font-size:clamp(24px,5.4vw,40px);font-weight:900;">Member Phone Number</h2>
          <p class="sub" style="margin:0 0 14px;">Type your number.</p>
          <input id="inpPhone" class="input" type="tel" placeholder="(555) 123-4567" inputmode="none" readonly>
          <div id="padPhone" class="pad-host" data-for="inpPhone"></div>

          <div style="display:grid; gap:14px; max-width:420px; width:100%; margin:16px auto 0;">
            <button id="btnNext" class="btn btn-gold">Next</button>
            <button id="back1" class="btn btn-dark">‚Üê Back</button>
          </div>
          <p id="msgPhone" style="display:none;color:#ff9aa1;margin-top:10px;"></p>
        </div>

            <!-- ========== [SECTION: SCREEN ‚Äì MEMBER CLASSES] (often changes) ========== -->
        <div id="scr-classes" class="screen">
          <div class="greet-row">
            <div id="profileBubble" class="profile-bubble">ME</div>
            <div class="greet-text">
              <h2 id="hello" class="greet">Welcome back</h2>
              <div class="meta-line">
                <span id="classesPill" class="pill-soft"></span>
                <span class="sep">‚Ä¢</span>
                <span class="meta">Pick today‚Äôs classes</span>
              </div>
            </div>
          </div>

          <div class="class-pills-container">
            <div id="classList" class="class-pills"></div>
          </div>

          <div class="cta-bar">
            <div class="hint-row">
              <span class="hint">Selected: <span class="count" id="selCount">0</span></span>
            </div>
            <button id="btnCheck" class="btn btn-gold btn-cta">Check In</button>
            <button id="back2" class="btn btn-dark">‚Üê Back</button>
            <div class="minor-row"><button id="btnNotMeClasses" class="link-btn">Not me</button></div>
          </div>

          <p id="msgClass" style="display:none;color:#ff9aa1;margin-top:10px;"></p>
        </div>

  <!-- ========== [SECTION: SCREEN ‚Äì SUCCESS] (text/timer changes) ========== -->
  <div id="scr-done" class="screen">
    <h2 id="doneTitle" style="font-size:clamp(26px,6vw,44px);margin:0 0 10px;font-weight:900;color:#a7f3c1">
      You‚Äôre checked in! ‚úÖ
    </h2>
    <p id="doneDetail" style="color:#d1d5db"></p>
    <p class="sub" style="margin:8px 0 18px;">Going back in <b id="countdown">5</b>‚Ä¶</p>
    <div style="display:grid; gap:14px; width:min(480px,100%); margin:0 auto;">
      <button id="btnDone" class="btn btn-dgold">Done</button>
    </div>
  </div>



        <!-- ========== [SECTION: SCREEN ‚Äì ADMIN FAB + MODAL] (sometimes changes) ========== -->
        <button id="adminFab" title="Admin"
          style="position:fixed;right:16px;bottom:16px;width:56px;height:56px;border-radius:999px;border:1px solid rgba(255,255,255,.2);background:#0f0f10;color:#fff;font-size:24px;cursor:pointer;box-shadow:0 10px 22px rgba(0,0,0,.6)">‚öôÔ∏è</button>

        <div id="adminModal">
          <div id="adminPanel">
            <div id="adminHeader" style="display:flex;align-items:center;justify-content:center;gap:10px;flex-wrap:wrap;margin-bottom:8px">
              <h3 style="margin:0;font-size:20px;font-weight:800;color:#f3f4f6;">Admin</h3>
              <span id="syncBadge" class="sync-badge" style="display:none">‚Ä¶</span>
            </div>
            <p style="margin:0 0 12px;opacity:.8;font-size:14px;color:#c9cacc">Enter PIN. Save goes to the cloud.</p>

            <div class="admin-row" style="justify-content:center;flex-direction:column;gap:12px">
              <div style="display:flex;gap:10px;align-items:center">
                <input id="adminPin" type="password" placeholder="PIN" style="padding:10px;border:1px solid rgba(255,255,255,.2);border-radius:8px;background:#0f1012;color:#fff;width:120px">
                <button id="adminUnlock" class="icon-btn add-btn">Unlock</button>
              </div>
              <span id="pinMsg" style="color:#ff9aa1;display:none;font-size:12px">Wrong PIN</span>
              <button id="adminClose" class="icon-btn del-btn">Close</button>
            </div>

            <div id="adminBody" style="display:none">
              <!-- Version Info Section -->
              <div class="admin-section">
                <h4 style="margin:4px 0 6px;color:#eee;text-align:center">System Info</h4>
                <div style="font-size:12px;color:#c9cacc;line-height:1.4;text-align:center;">
                  <div><strong>Version:</strong> <span id="versionDisplay">v2.6.0</span></div>
                  <div><strong>Environment:</strong> <span id="environmentDisplay">Loading...</span></div>
                  <div><strong>Last Updated:</strong> <span id="lastUpdatedDisplay">Jan 2025</span></div>
                </div>
                <div style="margin-top:12px;text-align:center">
                  <button id="debugToggle" style="padding:8px 16px;border:1px solid rgba(255,255,255,.2);border-radius:8px;background:#1d1f23;color:#cdd0d4;font-size:12px;cursor:pointer;font-weight:600">Debug: <span id="debugStatus">OFF</span></button>
                </div>
              </div>

              <!-- Contact Lookup Toggle -->
              <div class="admin-section">
                <h4 style="margin:4px 0 6px;color:#eee;text-align:center">Contact Lookup</h4>
                <p style="font-size:11px;color:#999;text-align:center;margin:0 0 10px">Choose where to check contacts</p>
                <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
                  <button id="lookupGHL" class="lookup-btn" data-source="ghl" style="flex:1;min-width:90px;padding:10px 14px;border:2px solid rgba(255,255,255,.2);border-radius:8px;background:#1d1f23;color:#cdd0d4;font-size:12px;cursor:pointer;font-weight:600;transition:all .2s">GHL</button>
                  <button id="lookupCRM" class="lookup-btn" data-source="crm" style="flex:1;min-width:90px;padding:10px 14px;border:2px solid rgba(255,255,255,.2);border-radius:8px;background:#1d1f23;color:#cdd0d4;font-size:12px;cursor:pointer;font-weight:600;transition:all .2s">CRM</button>
                  <button id="lookupBoth" class="lookup-btn" data-source="both" style="flex:1;min-width:90px;padding:10px 14px;border:2px solid rgba(255,255,255,.2);border-radius:8px;background:#1d1f23;color:#cdd0d4;font-size:12px;cursor:pointer;font-weight:600;transition:all .2s">Both</button>
                </div>
                <p style="font-size:10px;color:#888;text-align:center;margin:8px 0 0;line-height:1.3">
                  <strong id="currentLookupLabel">GHL</strong>: <span id="currentLookupDesc">Uses GoHighLevel (current)</span>
                </p>
              </div>
              
              <div class="admin-section">
                <h4 style="margin:4px 0 6px;color:#eee">Schedule</h4>
                <div id="scheduleGrid"></div>
                <div class="admin-row" style="justify-content:flex-end">
                  <button id="saveSchedule" class="icon-btn add-btn">Save Schedule</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;

    /* =============================== [SECTION: CLOUD LOAD ON START] (rarely changes) =============================== */
    setSyncBadge("bad","Offline");
    try{
      const r = await loadCloud();
      if(r && r.ok){
        if(Array.isArray(r.members) && r.members.length){ MEMBERS = r.members; }
        if(r.schedule && typeof r.schedule === "object"){ SCHEDULE = r.schedule; }
        setSyncBadge("ok","Synced ‚úì");
      } else { }
    }catch(_){ setSyncBadge("bad","Offline"); }

    /* =============================== [SECTION: STATE + SCREEN SWAP] (rarely changes) =============================== */
    let current = { phone:"", name:"" };
    let selected = new Set();
    
    // Enhanced screen transition with smooth animations
    const swap = (id, direction = 'forward', instantHide = false) => {
      const screens = ["scr-welcome","scr-drop","scr-phone","scr-classes","scr-done"];
      const current = screens.find(s => $("#"+s).classList.contains("show"));
      
      if (current) {
        const currentEl = $("#"+current);
        
        if (instantHide) {
          // Skip transition animation, hide immediately
          currentEl.classList.remove("show");
          currentEl.style.display = 'none';
          // Reset any previous animations on current screen
          resetScreenAnimations(currentEl);
        } else {
          // Normal smooth transition - wait for current to finish before showing new
          const slideClass = direction === 'back' ? 'slide-out-right' : 'slide-out-left';
          currentEl.classList.add(slideClass);
          // Reset any previous animations on current screen
          resetScreenAnimations(currentEl);
          
          setTimeout(() => {
            currentEl.classList.remove("show", slideClass);
            currentEl.style.display = 'none';
          }, 400);
        }
      }
      
      // For non-instant transitions, wait for current screen to finish sliding out
      setTimeout(() => {
        const newScreen = $("#"+id);
        // Reset any inline styles that might have been set during instant hide
        newScreen.style.opacity = '';
        newScreen.style.transform = '';
        newScreen.style.display = 'block';
        
        // Small delay to ensure display is set before adding show class
        setTimeout(() => {
          newScreen.classList.add("show");
          
          // Trigger specific animations based on screen
          if (id === 'scr-phone' || id === 'scr-drop') {
            // Start number pad animation immediately when screen shows
            setTimeout(() => animateNumberPad(), 100);
          } else if (id === 'scr-classes') {
            setTimeout(() => animateClassChips(), 200);
          } else if (id === 'scr-done') {
            setTimeout(() => animateSuccessScreen(), 200);
          } else if (id === 'scr-welcome') {
            setTimeout(() => animateWelcomeScreen(), 200);
          }
        }, 50);
      }, (current && !instantHide) ? 450 : 100);
    };
    
    // Reset animations on screen elements
    function resetScreenAnimations(screenEl) {
      const animatedElements = screenEl.querySelectorAll('.animate-in, .celebrate');
      animatedElements.forEach(el => {
        el.classList.remove('animate-in', 'celebrate');
        // Instantly hide number pad keys to prevent overlap
        if (el.classList.contains('nkey')) {
          el.style.opacity = '0';
          el.style.transform = 'translateY(15px) scale(0.9)';
        }
      });
    }
    
    // Animate welcome screen elements when returning
    function animateWelcomeScreen() {
      const slideElements = document.querySelectorAll('#scr-welcome .slide-in-element');
      slideElements.forEach((element, i) => {
        element.classList.remove('animate');
        setTimeout(() => {
          element.classList.add('animate');
        }, i * 50);
      });
    }
    
    // Animate number pad keys with stagger
    function animateNumberPad() {
      const keys = document.querySelectorAll('.nkey');
      keys.forEach((key, i) => {
        // Reset to hidden state first
        key.style.opacity = '0';
        key.style.transform = 'translateY(15px) scale(0.9)';
        key.classList.remove('animate-in');
        
        // Immediate for first key, then stagger
        const delay = i === 0 ? 0 : i * 30;
        setTimeout(() => {
          key.style.opacity = '';
          key.style.transform = '';
          key.classList.add('animate-in');
        }, delay);
      });
    }
    
    // Animate class chips with stagger
    function animateClassChips() {
      const chips = document.querySelectorAll('.chip');
      chips.forEach((chip, i) => {
        setTimeout(() => {
          chip.classList.add('animate-in');
        }, i * 100);
      });
    }
    
    // Animate success screen elements
    function animateSuccessScreen() {
      const elements = ['.success-title', '.success-detail', '.success-countdown', '.success-button'];
      elements.forEach(selector => {
        const el = document.querySelector(selector);
        if (el) el.classList.add('celebrate');
      });
    }

    /* =============================== [SECTION: HOME BUTTONS] (often changes) =============================== */
    withRippleDelay(document.getElementById('btnDropin'), ()=> swap('scr-drop', 'forward'));
    withRippleDelay(document.getElementById('btnMember'), ()=> swap('scr-phone', 'forward'));

    /* =============================== [SECTION: NUMPAD MOUNT] (rarely changes) =============================== */
    mountNumpad("inpDrop");
    mountNumpad("inpPhone");
    
    // Ensure all number pad keys start hidden
    setTimeout(() => {
      const keys = document.querySelectorAll('.nkey');
      keys.forEach(key => {
        key.style.opacity = '0';
        key.style.transform = 'translateY(15px) scale(0.9)';
        key.classList.remove('animate-in');
      });
    }, 50);

     /* =============================== [SECTION: DROP-IN LOGIC] (often changes) =============================== */
    function resetDropInput(){
      const box = $("#inpDrop");
      box.value = ""; box.dataset.digits = "";
    }

    withRippleDelay(document.getElementById('backDrop'), ()=>{
      resetDropInput();
      $("#dropNotFound").classList.remove("open");
      $("#dropErr").classList.remove("reveal");
      $("#dropBtns").classList.remove("reveal");
      $("#backDrop").classList.remove("shrink");
      
      swap('scr-welcome', 'back', true);
    });

    // Bind Member Phone back button ‚Üí Welcome
    withRippleDelay(document.getElementById('back1'), ()=>{
      const box = $("#inpPhone"); if(box){ box.value=''; box.dataset.digits=''; }
      const msg = $("#msgPhone"); if(msg) msg.style.display = 'none';
      
      swap('scr-welcome', 'back', true);
    });

    document.addEventListener('input', (e)=>{
      if(e.target && e.target.id === 'inpDrop'){ $("#msgDrop").style.display="none"; }
    }, {passive:true});

    // NEXT from drop-in keypad
    withRippleDelay(document.getElementById('btnDropNext'), async () => {
      const d = digits10($("#inpDrop").value);
      const box = $("#inpDrop");

      if (d.length !== 10) {
        $("#msgDrop").textContent = "Please type a full 10-digit number.";
        $("#msgDrop").style.display = "block";
        box.classList.add("input-error"); setTimeout(()=>box.classList.remove("input-error"), 400);
        return;
      }
      const btn=$("#btnDropNext");
      btn.classList.add("btn-disabled");
      showPulsingDots(btn);

      const result = await verifyDropIn(d);

      removePulsingDots(btn, "Next");
      btn.classList.remove("btn-disabled");

      if (result.exists) {
        // Redirect to drop-in options page, include multiple name params when available
        const backUrl = encodeURIComponent(window.location.href.split('#')[0]);
        const qp = new URLSearchParams({ phone: d, found: "1", back: backUrl });
        if (result.name) qp.set("name", result.name);
        if (result.email) qp.set("email", result.email);
        const url = `${DROPIN_RETURN_URL}?${qp.toString()}`;
        window.location.href = url;
      } else {
        // Show "Not found" state
        const nf = $("#dropNotFound");
        nf.dataset.phone = d; nf.classList.add("open");
        $("#dropErr").classList.add("reveal"); $("#dropBtns").classList.add("reveal");
        $("#backDrop").classList.add("shrink");
      }
    });

    // "I'm new" / "Try again"
    // Handle "Try again" button
    document.getElementById('btnDropRetry').addEventListener('click', ()=>{
      resetDropInput();
      $("#dropNotFound").classList.remove("open");
      $("#dropErr").classList.remove("reveal");
      $("#dropBtns").classList.remove("reveal");
      $("#backDrop").classList.remove("shrink");
      // Focus back on input for smooth UX
      setTimeout(() => $("#inpDrop").focus(), 100);
    });
    
    document.getElementById('btnDropImNew').addEventListener('click', ()=>{
      const d = $("#dropNotFound").dataset.phone || digits10($("#inpDrop").value);
      const popup = document.createElement('div');
      popup.id = 'newUserPopup';
      popup.style = `
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      `;
      popup.innerHTML = `
        <div style="background: #141519; padding: 20px; border-radius: 12px; max-width: 400px; width: 100%; text-align: center;">
          <h3 style="color: #f3f4f6; margin-bottom: 10px;">Welcome! Let‚Äôs get started</h3>
          <input id="firstName" class="input" placeholder="First Name" style="margin-bottom: 10px; width: calc(100% - 40px);">
          <input id="lastName" class="input" placeholder="Last Name" style="margin-bottom: 10px; width: calc(100% - 40px);">
          <input id="email" class="input" placeholder="Email" style="margin-bottom: 20px; width: calc(100% - 40px);">
          <div style="display: flex; gap: 10px; justify-content: center;">
            <button id="popupContinue" class="btn btn-gold">Continue</button>
            <button id="popupCancel" class="btn btn-dark">Cancel</button>
          </div>
        </div>
      `;
      document.body.appendChild(popup);

      document.getElementById('popupCancel').onclick = () => {
        popup.remove();
      };

      document.getElementById('popupContinue').onclick = async () => {
        const firstName = document.getElementById('firstName');
        const lastName = document.getElementById('lastName');
        const email = document.getElementById('email');

        let hasError = false;

        [firstName, lastName, email].forEach(field => {
          if (!field.value.trim()) {
            field.classList.add('input-error');
            setTimeout(() => field.classList.remove('input-error'), 400);
            hasError = true;
          }
        });

        if (hasError) return;

        const webhookUrl = "https://services.leadconnectorhq.com/hooks/3RfSeF58PmlwTx5aIQ0a/webhook-trigger/d94d472b-aaf4-478a-83f6-b55375fd7258";
        const crmWebhookUrl = window.location.hostname.includes('test.') 
          ? "https://test.mydancedesk.com/api/webhooks/tablet/check-in"
          : "https://crm.msbdance.com/api/webhooks/tablet/check-in";
        
        const payload = {
          phone: d,
          firstName: firstName.value.trim(),
          lastName: lastName.value.trim(),
          email: email.value.trim()
        };

        try {
          // Send to GHL (existing integration)
          await fetch(webhookUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          
          // Also send to CRM (new integration)
          try {
            await fetch(crmWebhookUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                phone: d,
                first_name: firstName.value.trim(),
                last_name: lastName.value.trim(),
                email: email.value.trim(),
                notes: 'New user signup from tablet'
              })
            });
          } catch (crmError) {
            console.warn("Failed to sync to CRM (continuing anyway):", crmError);
          }
        } catch (error) {
          console.error("Failed to send data to webhook", error);
          alert("There was an error adding you to the system. Please try again.");
          return;
        }

        const url = `${DROPIN_RETURN_URL}?phone=${encodeURIComponent(d)}&name=${encodeURIComponent(firstName.value.trim())}`;
        window.location.href = url;
      };
    });



    /* =============================== [SECTION: ADMIN PANEL] (sometimes changes) =============================== */
    const adminFab=$("#adminFab"), adminModal=$("#adminModal");
    const adminPin=$("#adminPin"), adminUnlock=$("#adminUnlock"), pinMsg=$("#pinMsg");
    const adminBody=$("#adminBody"), adminClose=$("#adminClose");
    const scheduleGrid=$("#scheduleGrid"), saveSchedule=$("#saveSchedule");
    // Removed members admin UI; guard against any legacy references

    adminFab.onclick=()=>{ 
      adminModal.style.display="flex"; 
      document.body.style.overflow="hidden"; 
      pinMsg.style.display="none"; 
      adminBody.style.display="none"; 
      adminPin.value=""; 
      adminPin.focus(); 
      // Reset to compact size
      $("#adminPanel").classList.remove("expanded");
      $("#adminHeader").style.justifyContent="center";
      $("#syncBadge").style.display="none";
    };
    adminClose.onclick=()=>{ adminModal.style.display="none"; document.body.style.overflow=""; };

    adminUnlock.onclick=()=>{
      if(adminPin.value===ADMIN_PIN){
        pinMsg.style.display="none"; 
        adminBody.style.display="block";
        // Expand panel and show full header
        $("#adminPanel").classList.add("expanded");
        $("#adminHeader").style.justifyContent="space-between";
        $("#syncBadge").style.display="inline";
        // Update version info
        updateVersionDisplay();
        // Only render schedule editor now
        renderScheduleEditor();
      }else{ pinMsg.style.display="inline"; adminBody.style.display="none"; }
    };
    
    function updateVersionDisplay(){
      $("#versionDisplay").textContent = VERSION;
      $("#lastUpdatedDisplay").textContent = BUILD_DATE;
      
      // Detect environment
      let env = "Unknown";
      if(DEV) env = "Development (localhost)";
      else if(TEST) env = "Test (test.tablet.msbdance.com)";
      else env = "Production (tablet.msbdance.com)";
      
      $("#environmentDisplay").textContent = env;
      
      // Setup debug toggle
      const debugToggle = $("#debugToggle");
      const debugStatus = $("#debugStatus");
      if(debugToggle){
        const updateDebugUI = ()=>{
          const isDebugOn = localStorage.getItem('debug') === '1';
          debugStatus.textContent = isDebugOn ? 'ON' : 'OFF';
          debugToggle.style.background = isDebugOn ? '#1b2a19' : '#1d1f23';
          debugToggle.style.borderColor = isDebugOn ? '#2a5a36' : 'rgba(255,255,255,.2)';
          debugStatus.style.color = isDebugOn ? '#b9f6ce' : '#cdd0d4';
        };
        updateDebugUI();
        debugToggle.onclick = ()=>{
          const currentState = localStorage.getItem('debug') === '1';
          localStorage.setItem('debug', currentState ? '0' : '1');
          updateDebugUI();
          alert('Debug mode ' + (currentState ? 'disabled' : 'enabled') + '. Reload the page to apply changes.');
        };
      }

      // Contact Lookup Toggle
      {
        const lookupBtns = document.querySelectorAll('.lookup-btn');
        const currentLabel = document.getElementById('currentLookupLabel');
        const currentDesc = document.getElementById('currentLookupDesc');
        
        const updateLookupUI = () => {
          const source = localStorage.getItem('contactLookupSource') || 'ghl'; // Default to GHL
          lookupBtns.forEach(btn => {
            const btnSource = btn.getAttribute('data-source');
            if (btnSource === source) {
              btn.style.borderColor = '#d4af37';
              btn.style.background = 'rgba(212, 175, 55, 0.15)';
              btn.style.color = '#d4af37';
            } else {
              btn.style.borderColor = 'rgba(255,255,255,.2)';
              btn.style.background = '#1d1f23';
              btn.style.color = '#cdd0d4';
            }
          });
          
          const descriptions = {
            ghl: 'Uses GoHighLevel (current)',
            crm: 'Uses MyDanceDesk CRM (faster)',
            both: 'Tries CRM first, falls back to GHL'
          };
          if (currentLabel) currentLabel.textContent = source.toUpperCase();
          if (currentDesc) currentDesc.textContent = descriptions[source] || descriptions.ghl;
        };
        
        updateLookupUI();
        
        lookupBtns.forEach(btn => {
          btn.onclick = () => {
            const source = btn.getAttribute('data-source');
            localStorage.setItem('contactLookupSource', source);
            updateLookupUI();
          };
        });
      }
    }

    function renderScheduleEditor(){
      const DAY_LABEL={sun:"Sunday",mon:"Monday",tue:"Tuesday",wed:"Wednesday",thu:"Thursday",fri:"Friday",sat:"Saturday"};
      scheduleGrid.innerHTML = DAY_KEYS.map(k=>{
        const items = (SCHEDULE[k]||[]).map((c,i)=>rowHTML(k,i,c)).join("");
        return `<div class="day-card" data-day="${k}">
          <div class="day-header">
            <strong>${DAY_LABEL[k]}</strong>
            <button class="icon-btn add-btn" data-add="${k}">+ Add Class</button>
          </div>
          <div class="day-rows" id="rows-${k}">${items || rowHTML(k,0,"")}</div>
        </div>`;
      }).join("");

      scheduleGrid.onclick = (e)=>{
        const addDay = e.target.getAttribute?.("data-add");
        const delKey = e.target.getAttribute?.("data-del");
        if(addDay){
          const box=$("#rows-"+addDay); const idx=box.querySelectorAll(".class-row").length;
          box.insertAdjacentHTML("beforeend", rowHTML(addDay,idx,""));
        }
        if(delKey){
          const [day,idx]=delKey.split(":");
          const row=scheduleGrid.querySelector(`.class-row[data-key="${day}:${idx}"]`);
          if(row) row.remove();
        }
      };
    }
    function rowHTML(day,idx,val){
      const v=String(val||"").replace(/"/g,"&quot;");
      return `<div class="class-row" data-key="${day}:${idx}">
        <input type="text" placeholder="e.g., Salsa 6:00" value="${v}">
        <button class="icon-btn del-btn" data-del="${day}:${idx}">Remove</button>
      </div>`;
    }

    // Remove legacy members save handler (UI removed)

    saveSchedule.onclick = async ()=>{
      const next={sun:[],mon:[],tue:[],wed:[],thu:[],fri:[],sat:[]};
      DAY_KEYS.forEach(k=>{
        document.querySelectorAll(`#rows-${k} .class-row input`).forEach(inp=>{
          const v=inp.value.trim(); if(v) next[k].push(v);
        });
      });
      SCHEDULE = next;
      const r = await saveScheduleCloud(SCHEDULE); if(r && r.ok) setSyncBadge("ok","Synced ‚úì"); else setSyncBadge("bad","Offline");
    };

    /* =============================== [SECTION: MEMBER VERIFY ‚Äì TOGGLE BETWEEN GHL/CRM] =============================== */
    
    async function verifyMember(phone, { timeoutMs = 8000 } = {}){
      try{
        const d = String(phone||"").replace(/\D/g, "").slice(-10);
        if(d.length!==10) return { exists:false };
        
        const lookupSource = localStorage.getItem('contactLookupSource') || 'ghl';
        
        // Try CRM first if source is 'crm' or 'both'
        if (lookupSource === 'crm' || lookupSource === 'both') {
          try {
            const crmResult = await verifyViaCRM(d, 'checkmember', timeoutMs);
            if (crmResult.exists) return crmResult; // Found in CRM
            if (lookupSource === 'crm') return { exists: false }; // CRM-only mode, not found
          } catch (err) {
            if (lookupSource === 'crm') return { exists: false }; // CRM-only mode failed
            // Fall through to GHL for 'both' mode
          }
        }
        
        // Use GHL (Make.com) if source is 'ghl' or fallback from 'both'
        return await verifyViaGHL(d, 'checkmember', timeoutMs);
      }catch(_){ return { exists:false }; }
    }
    
    // GHL lookup via Make.com (original logic)
    async function verifyViaGHL(phone, product, timeoutMs = 8000){
      try{
        const u = new URL(MAKE_WEBHOOK_URL);
        u.searchParams.set("product", product);
        u.searchParams.set("phone", phone);
        const ctrl = new AbortController();
        const to = setTimeout(() => ctrl.abort("timeout"), timeoutMs);
        const resp = await fetch(u.toString(), { method:"GET", signal: ctrl.signal, cache:"no-store" });
        clearTimeout(to);
        if(!resp.ok) return { exists:false };
        const ct = resp.headers.get("content-type")||"";
        let data; let rawText="";
        if(ct.includes("application/json")){
          data = await resp.json();
        } else {
          rawText = await resp.text();
          try{ data = JSON.parse(rawText); }
          catch{ data = { result:(rawText||"").trim() , _raw: rawText}; }
        }

        let exists = false;
        if (data) {
          const r = (typeof data.result === 'string') ? data.result.toLowerCase() : data.result;
          exists = (r === 'yes') || (typeof r === 'string' && /\byes\b/.test(r)) || data.ok === true || data.exists === true;
        }
        if (!exists && rawText) {
          const lower = rawText.toLowerCase();
          if (/\byes\b/.test(lower)) exists = true;
        }

        const nameInfo = extractNameDeep(data||{});
        const classesTaken = Number((data && (data.classesTaken ?? data.classcount ?? data.classCount)) || 0) || 0;
        return { exists, name: nameInfo.name, classesTaken };
      }catch(_){ return { exists:false }; }
    }

    // NEXT from member keypad ‚Üí use Make.com
    withRippleDelay(document.getElementById('btnNext'), async () => {
      const d = digits10($("#inpPhone").value);
      const box = $("#inpPhone");

      if (d.length !== 10) {
        $("#msgPhone").textContent = "Please type a full 10-digit number.";
        $("#msgPhone").style.display = "block";
        box.classList.add("input-error"); setTimeout(()=>box.classList.remove("input-error"), 400);
        return;
      }

      // Disable Next and show dots while verifying
      const btn = document.getElementById('btnNext');
      btn.classList.add('btn-disabled');
      const originalLabel = btn.textContent; btn.textContent=""; showPulsingDots(btn);

      const result = await verifyMember(d);

      // Debug log
      try{ if (typeof DEV !== 'undefined' && DEV) console.log('[MEMBER] verify result', result); }catch(_){ }

      removePulsingDots(btn, originalLabel); btn.classList.remove('btn-disabled');

      if(!result.exists){
        $("#msgPhone").textContent = "We didn‚Äôt find that number.";
        $("#msgPhone").style.display = "block";
        box.classList.add("input-error"); setTimeout(()=>box.classList.remove("input-error"), 400);
        return;
      }

      // Success ‚Üí go to classes with premium UI
      try {
        current.phone = d;
        current.name  = result.name || "Member";
        $("#hello").textContent = `Welcome back, ${current.name}`;
        // initials - just first initial
        const getInitials = name => { const p=String(name||"").split(/\s+/).filter(Boolean); return p[0] ? p[0][0] : "M"; };
        const pb = $("#profileBubble"); if(pb) pb.textContent = getInitials(current.name).toUpperCase();
        // classes pill with count-up animation
        const classesTaken = Number(result.classesTaken)||0; 
        const pill=$("#classesPill"); 
        if(pill) countUpClasses(pill, classesTaken, 3000);
        $("#selCount").textContent = "0";
        swap('scr-classes');

        // Render chips (no checkbox icon, left accent on select)
        const classListEl = $("#classList");
        if(classListEl){
          classListEl.innerHTML = ""; selected.clear();
          (SCHEDULE[todayKey()] || []).forEach(cls => {
            const b = document.createElement("button");
            b.className = "chip";
            b.innerHTML = `
              <div class="row">
                <span class="icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12" />
                  </svg>
                </span>
                <span class="label">${cls}</span>
              </div>
              <span class="right">Tap to select</span>
            `;
            b.onclick = () => {
              const picked = b.classList.toggle("sel");
              if(picked) selected.add(cls); else selected.delete(cls);
              const sel = $("#selCount"); if(sel) sel.textContent = String(selected.size);
              const right=b.querySelector('.right'); if(right) right.textContent = picked?"Selected":"Tap to select";
            };
            classListEl.appendChild(b);
          });
        }

        swap("scr-classes", 'forward');
      } catch (err){
        console.error('[MEMBER] UI update error', err);
        $("#msgPhone").textContent = "An internal error occurred. Please tell staff.";
        $("#msgPhone").style.display = 'block';
      }
    });

    /* =============================== [SECTION: CLASSES SCREEN NAV BUTTONS] =============================== */
    // Bind classes screen nav buttons after HTML injected
    const back2El = document.getElementById('back2');
    if (back2El) withRippleDelay(back2El, () => { 
      swap('scr-phone', 'back', true); 
    });

    const notMeEl = document.getElementById('btnNotMeClasses');
    if (notMeEl) {
      notMeEl.addEventListener('click', () => {
        selected.clear();
        const classListEl = document.getElementById('classList');
        if (classListEl) classListEl.querySelectorAll('.chip.sel').forEach(el=>el.classList.remove('sel'));
        const box = document.getElementById('inpPhone');
        if (box) { box.value=''; box.dataset.digits=''; }
        const msg = document.getElementById('msgPhone');
        if (msg) msg.style.display = 'none';
        
        swap('scr-phone', 'back', true);
      });
    }

    /* =============================== [SECTION: ANIMATIONS] =============================== */
    // Ultra-smooth adaptive curve that adjusts based on class count
    function smoothDramaticSlowdown(t, targetNumber) {
      // Adaptive curve strength based on class count
      let curveStrength;
      if (targetNumber < 20) {
        curveStrength = 1.8; // Gentle curve for small numbers
      } else if (targetNumber < 50) {
        curveStrength = 2.2; // Medium curve
      } else if (targetNumber < 100) {
        curveStrength = 2.6; // Stronger curve
      } else {
        curveStrength = 3.0; // Strongest curve for large numbers
      }
      
      // Single ultra-smooth curve using sine-based easing
      // This creates a natural acceleration then deceleration without jarring transitions
      const sineEase = Math.sin(t * Math.PI * 0.5); // 0 to œÄ/2 gives smooth S-curve
      const powerEase = Math.pow(sineEase, curveStrength);
      
      // Blend between linear and power curve based on progress
      // Early: more linear (fast), Late: more curved (dramatic slowdown)
      const blendFactor = Math.pow(t, 0.7); // Gradual transition to dramatic
      return t * (1 - blendFactor) + powerEase * blendFactor;
    }
    
    function countUpClasses(element, targetNumber, duration = 3000) {
      if (!element || targetNumber === 0) {
        if (element) element.textContent = '0 classes';
        return;
      }
      
      const startTime = performance.now();
      element.textContent = '0 classes';
      
      function animate(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // Apply ultra-smooth dramatic slowdown easing
        const easedProgress = smoothDramaticSlowdown(progress, targetNumber);
        const currentCount = Math.floor(targetNumber * easedProgress);
        
        element.textContent = `${currentCount} ${currentCount === 1 ? 'class' : 'classes'}`;
        
        if (progress < 1) {
          requestAnimationFrame(animate);
        }
      }
      
      requestAnimationFrame(animate);
    }

    /* =============================== [SECTION: CHECK IN BUTTON] =============================== */
    // Wire up the Check In button for member classes screen
    withRippleDelay(document.getElementById('btnCheck'), async () => {
      if (selected.size === 0) {
        const msg = document.getElementById('msgClass');
        if (msg) { 
          msg.textContent = 'Please select at least one class.'; 
          msg.style.display = 'block'; 
          setTimeout(() => msg.style.display = 'none', 2600); 
        }
        return;
      }

      const btn = document.getElementById('btnCheck');
      const original = btn ? btn.textContent : '';
      if (btn) { 
        btn.classList.add('btn-disabled'); 
        btn.disabled = true; 
        btn.textContent = ''; 
        showPulsingDots(btn); 
      }

      const classes = Array.from(selected);

      try {
        await sendGHLMemberCheckin({ phone: current.phone, name: current.name, classes });
        await logCheckin(current.phone, current.name, classes.join(', '));

        const detail = document.getElementById('doneDetail');
        if (detail) detail.textContent = `Checked in for: ${classes.join(', ')}`;
        swap('scr-done', 'forward');

        let t = COUNTDOWN_SEC; 
        const cd = document.getElementById('countdown'); 
        if (cd) cd.textContent = String(t);
        
        const timer = setInterval(() => {
          t -= 1; 
          if (cd) cd.textContent = String(Math.max(0, t));
          if (t <= 0) { 
            clearInterval(timer);
            // Add smooth exit animation before redirect
            const doneScreen = document.getElementById('scr-done');
            if (doneScreen) {
              doneScreen.classList.add('exit');
              setTimeout(() => {
                window.location.href = HOME_URL;
              }, 1000); // Wait for exit animation to complete
            } else {
              window.location.href = HOME_URL;
            }
          }
        }, 1000);

        withRippleDelay(document.getElementById('btnDone'), () => { 
          try { clearInterval(timer); } catch(_) { }
          // Add smooth exit animation before redirect
          const doneScreen = document.getElementById('scr-done');
          if (doneScreen) {
            doneScreen.classList.add('exit');
            setTimeout(() => {
              window.location.href = HOME_URL;
            }, 1000); // Wait for exit animation to complete
          } else {
            window.location.href = HOME_URL;
          }
        });
      } catch (err) {
        console.error('[CHECKIN] failed', err);
        alert('There was an error during check-in. Please try again.');
        if (btn) { 
          removePulsingDots(btn, original || 'Check In'); 
          btn.classList.remove('btn-disabled'); 
          btn.disabled = false; 
        }
      }
    });
    
    function renderScheduleEditor(){
      const DAY_LABEL={sun:"Sunday",mon:"Monday",tue:"Tuesday",wed:"Wednesday",thu:"Thursday",fri:"Friday",sat:"Saturday"};
      scheduleGrid.innerHTML = DAY_KEYS.map(k=>{
        const items = (SCHEDULE[k]||[]).map((c,i)=>rowHTML(k,i,c)).join("");
        return `<div class="day-card" data-day="${k}">
          <div class="day-header">
            <strong>${DAY_LABEL[k]}</strong>
            <button class="icon-btn add-btn" data-add="${k}">+ Add Class</button>
          </div>
          <div class="day-rows" id="rows-${k}">${items || rowHTML(k,0,"")}</div>
        </div>`;
      }).join("");

      scheduleGrid.onclick = (e)=>{
        const addDay = e.target.getAttribute?.("data-add");
        const delKey = e.target.getAttribute?.("data-del");
        if(addDay){
          const box=$("#rows-"+addDay); const idx=box.querySelectorAll(".class-row").length;
          box.insertAdjacentHTML("beforeend", rowHTML(addDay,idx,""));
        }
        if(delKey){
          const [day,idx]=delKey.split(":");
          const row=scheduleGrid.querySelector(`.class-row[data-key="${day}:${idx}"]`);
          if(row) row.remove();
        }
      };
    }
    function rowHTML(day,idx,val){
      const v=String(val||"").replace(/"/g,"&quot;");
      return `<div class="class-row" data-key="${day}:${idx}">
        <input type="text" placeholder="e.g., Salsa 6:00" value="${v}">
        <button class="icon-btn del-btn" data-del="${day}:${idx}">Remove</button>
      </div>`;
    }

    // Remove legacy members save handler (UI removed)

    saveSchedule.onclick = async ()=>{
      const next={sun:[],mon:[],tue:[],wed:[],thu:[],fri:[],sat:[]};
      DAY_KEYS.forEach(k=>{
        document.querySelectorAll(`#rows-${k} .class-row input`).forEach(inp=>{
          const v=inp.value.trim(); if(v) next[k].push(v);
        });
      });
      SCHEDULE = next;
      const r = await saveScheduleCloud(SCHEDULE); if(r && r.ok) setSyncBadge("ok","Synced ‚úì"); else setSyncBadge("bad","Offline");
    };
    
    // Trigger smooth slide-in animations for seamless transitions from payment success
    // Fade out instant loader and show content
    const instantLoader = document.getElementById('instantLoader');
    const slideElements = document.querySelectorAll('.slide-in-element');
    
    // Start content animations immediately
    slideElements.forEach(element => {
      element.classList.add('animate');
    });
    
    // Fade out loader after content starts animating
    setTimeout(() => {
      if (instantLoader) {
        instantLoader.classList.add('fade-out');
        setTimeout(() => {
          instantLoader.remove();
        }, 400);
      }
    }, 150);
  });
  </script>

  <!-- =============================== [SECTION: STYLES ‚Äì CTA BAR] =============================== -->
  <style>
    /* CTA Bar with Selected counter and Check In button */
    .cta-bar{ width:min(860px,100%); margin:0 auto; }
    .hint-row{ text-align:center; margin-bottom:16px; }
    .hint{ color:var(--muted); font-weight:600; font-size:clamp(14px,3vw,18px); }
    .hint .count{ color:var(--gold1); font-weight:800; }
    
    /* Make buttons match chip width exactly */
    .cta-bar{ width:min(900px,100%); margin:0 auto; padding:0 8px; }
    .cta-bar .btn{ 
      width:100%; 
      margin:0 auto 10px; 
      display:block;
    }
    .btn-cta{ min-height:56px; }
  </style>

  <!-- =============================== [SECTION: STYLES ‚Äì PREMIUM CLASSES UI] =============================== -->
  <style>
    /* Premium Classes UI ‚Äì frosted chips with gold ring on select */
    .greet-row{ display:flex; align-items:center; gap:12px; width:min(900px,100%); margin:0 auto 16px; text-align:left; padding:0 8px; }
    .greet-text .greet{ margin:0; font-size:clamp(20px,4.2vw,28px); font-weight:900; }
    .greet-text .meta-line{ display:flex; align-items:center; gap:8px; color:var(--muted); font-size:clamp(11px,2.2vw,13px); flex-wrap:wrap; }
    .profile-bubble{ width:44px; height:44px; border-radius:999px; display:flex; align-items:center; justify-content:center; font-weight:900; color:#1b1400; background:linear-gradient(180deg,var(--gold1),var(--gold2)); box-shadow: inset 0 -1px 0 rgba(0,0,0,.35); flex-shrink:0; }
    .pill-soft{ padding:3px 9px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.14); font-size:clamp(10px,2vw,12px); }

    /* Scrollable container for class list to prevent overflow */
    .class-pills-container{ 
      max-height:calc(100vh - 340px); 
      overflow-y:auto; 
      padding:0 8px 16px; 
      margin-bottom:16px;
      /* Hide scrollbar for user-facing UI */
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE/Edge */
    }
    /* Hide scrollbar for Chrome/Safari/Opera */
    .class-pills-container::-webkit-scrollbar{ display:none; }

    /* 2-column grid for tablets to reduce scrolling */
    .class-pills{ 
      display:grid; 
      gap:10px; 
      width:100%; 
      margin:0 auto;
      grid-template-columns:repeat(auto-fit, minmax(min(100%, 420px), 1fr));
    }
    
    @media (min-width:700px) and (max-width:1200px){
      .class-pills{ grid-template-columns:repeat(2, 1fr); }
    }

    /* Base frosted look with animation */
    .chip{ 
      background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.16); 
      backdrop-filter:blur(8px) saturate(1.1); -webkit-backdrop-filter:blur(8px) saturate(1.1);
      opacity:0; transform:translateY(20px) scale(0.95);
      transition:all .5s cubic-bezier(0.34, 1.56, 0.64, 1), 
                 border-color .3s ease, background .3s ease, box-shadow .3s ease;
      padding:18px 22px;
      font-size:clamp(17px, 3.8vw, 26px);
    }
    .chip.animate-in{
      opacity:1; transform:translateY(0) scale(1);
    }
    .chip:hover:not(.checked){
      transform:translateY(-3px) scale(1.02);
      background:rgba(255,255,255,.08);
      box-shadow:0 10px 30px rgba(0,0,0,.2);
    }
    .chip .row{ display:inline-flex; align-items:center; gap:10px; }
    .chip .label{ display:inline-block; }
    .chip .right{ display:block; font-weight:700; color:var(--muted); font-size:clamp(12px,2.6vw,14px); margin-top:6px; }

    /* Check icon ‚Äì keep small and subtle; reveal on select */
    .chip .icon{ width:22px; height:22px; display:inline-flex; align-items:center; justify-content:center; border-radius:6px; border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.06); color:#c9cacc; opacity:0; transform:scale(.85); transition:opacity .16s ease, transform .16s ease, border-color .2s, background .2s, color .2s; }
    .chip .icon svg{ width:14px; height:14px; }

    /* Selection ring turns gold; no full gold fill */
    .chip.sel{ background:rgba(255,255,255,.06) !important; color:#eee !important; border-color:rgba(255,215,130,.7) !important; box-shadow:0 0 0 2px rgba(255,215,130,.18) inset; }
    .chip.sel .icon{ opacity:1; transform:scale(1); color:var(--gold2); border-color:rgba(255,215,130,.6); background:rgba(255,215,130,.08); }
  </style>
</body>
</html>